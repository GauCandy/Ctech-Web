<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dịch vụ trực tuyến | CTECH</title>
    <link rel="icon" type="image/webp" href="/img/logo.webp" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/css/main.css" />
    <link rel="stylesheet" href="/css/loader.css" />
    <link rel="stylesheet" href="/css/services.css" />
    <link rel="stylesheet" href="/css/user-menu.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <script src="/js/themeManager.js"></script>
    <script src="/js/remoteGestures.js"></script>
    <script src="/js/headerManager.js"></script>
    <script src="/js/swRegister.js"></script>
  </head>
  <body>
    <div id="app-loader" class="loader-backdrop" aria-hidden="true">
      <div class="loader-logo">
        <img src="/img/logo.webp" alt="Logo CTECH" />
      </div>
    </div>

    <header class="site-header">
      <div class="header-inner container">
        <a class="brand" href="/home" aria-label="Trang chủ CTECH">
          <img src="/img/logo.webp" alt="Logo CTECH" />
        </a>
        <div class="header-actions">
          <nav class="nav-links" aria-label="Điều hướng chính">
            <a href="/">Trang chủ</a>
            <a href="/#tai-sao-chon-ctech">Giới thiệu</a>
            <a href="/#chuong-trinh">Chương trình</a>
            <a href="/#doi-song">Đời sống</a>
            <a href="/services" class="active">Dịch vụ</a>
            <a href="/schedule">Lịch trình</a>
          </nav>
          <div id="theme-toggle-container"></div>
          <div class="user-indicator" data-user-indicator>
            <a class="user-link" href="/login">Đăng nhập</a>
          </div>
        </div>
      </div>
    </header>

    <main class="services-main">
      <section class="services-hero">
        <div class="container services-hero__content">
          <h1 class="services-hero__title">Truy cập kho dịch vụ số của CTECH</h1>
          <p class="services-hero__subtitle">
            Đồng bộ dữ liệu trực tiếp từ API dịch vụ để tra cứu, theo dõi và nhận mã thanh toán một cách minh bạch.
          </p>
        </div>
      </section>

      <section class="container services-shell">
        <div class="services-panel">
          <!-- Category filter -->
          <div class="services-categories" data-categories-container>
            <div class="services-categories__loading">Đang tải danh mục...</div>
          </div>

          <form class="services-controls" data-services-form>
            <div class="services-controls__row">
              <div class="services-field">
                <label for="service-search">Từ khóa tìm kiếm</label>
                <input
                  id="service-search"
                  name="q"
                  type="search"
                  inputmode="search"
                  autocomplete="off"
                  placeholder="Nhập mã, tên hoặc mô tả dịch vụ..."
                  data-services-search
                />
              </div>
            </div>

            <div class="services-controls__row">
              <div class="services-actions">
                <button type="submit" class="services-button" data-services-apply>
                  Tìm dịch vụ
                </button>
                <button type="button" class="services-button secondary" data-services-refresh>
                  Tải lại
                </button>
                <button type="button" class="services-button secondary" data-services-reset>
                  Đặt lại bộ lọc
                </button>
                <button type="button" class="services-button secondary" data-order-history-btn>
                  Lịch sử đơn hàng
                </button>
                <button type="button" class="services-button primary" data-add-service-btn style="display: none;">
                  + Thêm dịch vụ
                </button>
              </div>
              <div class="services-meta" data-services-summary aria-live="polite"></div>
            </div>
          </form>

          <div class="services-layout">
            <div class="services-list" data-services-list role="list" aria-live="polite">
              <p class="services-list__status">Đang khởi tạo dữ liệu dịch vụ...</p>
            </div>

            <section class="services-detail" data-service-detail aria-live="polite">
              <div class="service-detail__empty">
                <div>
                  <strong>Chọn một dịch vụ để xem chi tiết</strong>
                  <p>Danh sách được đồng bộ theo thời gian thực từ API dịch vụ.</p>
                </div>
              </div>
            </section>
          </div>
        </div>
      </section>
    </main>

    <!-- Modal lich su don hang -->
    <div id="order-history-modal" class="order-history-modal" style="display: none;">
      <div class="order-history-backdrop" data-modal-backdrop></div>
      <div class="order-history-content">
        <div class="order-history-header">
          <h2>Lịch sử đơn hàng</h2>
          <button type="button" class="order-history-close" data-modal-close>&times;</button>
        </div>
        <div class="order-history-body" data-order-list></div>
      </div>
    </div>

    <!-- Modal them dich vu (Admin only) -->
    <div id="add-service-modal" class="add-service-modal" style="display: none;">
      <div class="add-service-backdrop" data-add-service-backdrop></div>
      <div class="add-service-content">
        <div class="add-service-header">
          <h2>Thêm dịch vụ mới</h2>
          <button type="button" class="add-service-close" data-add-service-close>&times;</button>
        </div>
        <div class="add-service-body">
          <form id="add-service-form" class="add-service-form">
            <div class="services-field">
              <label for="new-service-name">Tên dịch vụ *</label>
              <input
                type="text"
                id="new-service-name"
                name="name"
                required
                placeholder="VD: Đăng ký học phần"
              />
            </div>

            <div class="services-field">
              <label for="new-service-category">Danh mục (chọn có sẵn hoặc nhập mới)</label>
              <input
                type="text"
                id="new-service-category"
                name="category"
                list="category-datalist"
                placeholder="VD: Học tập, Hành chính..."
                autocomplete="off"
              />
              <datalist id="category-datalist"></datalist>
            </div>

            <div class="services-field">
              <label for="new-service-description">Mô tả</label>
              <textarea
                id="new-service-description"
                name="description"
                rows="4"
                placeholder="Mô tả chi tiết về dịch vụ..."
              ></textarea>
            </div>

            <div class="services-field">
              <label for="new-service-price">Giá (VND)</label>
              <input
                type="number"
                id="new-service-price"
                name="price"
                min="0"
                step="1000"
                placeholder="0"
              />
            </div>

            <div class="services-field">
              <label for="new-service-image">Hình ảnh dịch vụ</label>
              <input
                type="file"
                id="new-service-image"
                name="image"
                accept="image/jpeg,image/jpg,image/png,image/gif,image/webp"
                data-image-input
              />
              <div class="image-preview" data-image-preview style="display: none;">
                <img src="" alt="Preview" />
                <button type="button" class="image-preview-remove" data-image-remove>&times;</button>
              </div>
            </div>

            <div class="services-field">
              <label>
                <input type="checkbox" name="isActive" checked />
                <span>Kích hoạt dịch vụ ngay</span>
              </label>
            </div>

            <div class="add-service-actions">
              <button type="submit" class="services-button primary">Tạo dịch vụ</button>
              <button type="button" class="services-button secondary" data-add-service-cancel>Hủy</button>
            </div>

            <div class="add-service-feedback" data-add-service-feedback></div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal edit dich vu (Admin only) -->
    <div id="edit-service-modal" class="add-service-modal" style="display: none;">
      <div class="add-service-backdrop" data-edit-service-backdrop></div>
      <div class="add-service-content">
        <div class="add-service-header">
          <h2>Chỉnh sửa dịch vụ</h2>
          <button type="button" class="add-service-close" data-edit-service-close>&times;</button>
        </div>
        <div class="add-service-body">
          <form id="edit-service-form" class="add-service-form">
            <input type="hidden" id="edit-service-code" name="serviceCode" />

            <div class="services-field">
              <label for="edit-service-name">Tên dịch vụ *</label>
              <input
                type="text"
                id="edit-service-name"
                name="name"
                required
                placeholder="VD: Đăng ký học phần"
              />
            </div>

            <div class="services-field">
              <label for="edit-service-category">Danh mục (chọn có sẵn hoặc nhập mới)</label>
              <input
                type="text"
                id="edit-service-category"
                name="category"
                list="category-datalist-edit"
                placeholder="VD: Học tập, Hành chính..."
                autocomplete="off"
              />
              <datalist id="category-datalist-edit"></datalist>
            </div>

            <div class="services-field">
              <label for="edit-service-description">Mô tả</label>
              <textarea
                id="edit-service-description"
                name="description"
                rows="4"
                placeholder="Mô tả chi tiết về dịch vụ..."
              ></textarea>
            </div>

            <div class="services-field">
              <label for="edit-service-price">Giá (VND)</label>
              <input
                type="number"
                id="edit-service-price"
                name="price"
                min="0"
                step="1000"
                placeholder="0"
              />
            </div>

            <div class="services-field">
              <label for="edit-service-image">Hình ảnh dịch vụ</label>
              <input
                type="file"
                id="edit-service-image"
                name="image"
                accept="image/jpeg,image/jpg,image/png,image/gif,image/webp"
                data-edit-image-input
              />
              <div class="image-preview" data-edit-image-preview style="display: none;">
                <img src="" alt="Preview" data-edit-preview-img />
                <button type="button" class="image-preview-remove" data-edit-image-remove>&times;</button>
              </div>
            </div>

            <div class="services-field">
              <label>
                <input type="checkbox" id="edit-service-active" name="isActive" />
                <span>Kích hoạt dịch vụ</span>
              </label>
            </div>

            <div class="add-service-actions">
              <button type="submit" class="services-button primary">Cập nhật dịch vụ</button>
              <button type="button" class="services-button secondary" data-edit-service-cancel>Hủy</button>
            </div>

            <div class="add-service-feedback" data-edit-service-feedback></div>
          </form>
        </div>
      </div>
    </div>

    <script>
      (() => {
        const loader = document.getElementById('app-loader');
        if (loader) {
          const hideLoader = () => {
            requestAnimationFrame(() => {
              loader.dataset.hidden = 'true';
              setTimeout(() => {
                loader.remove();
              }, 600);
            });
          };

          window.addEventListener('load', hideLoader, { once: true });
          setTimeout(hideLoader, 2500);
        }
      })();
    </script>

    <script>
      (() => {
        const listEl = document.querySelector('[data-services-list]');
        const summaryEl = document.querySelector('[data-services-summary]');
        const detailEl = document.querySelector('[data-service-detail]');
        const formEl = document.querySelector('[data-services-form]');
        const searchInput = document.querySelector('[data-services-search]');
        const activeSelect = document.querySelector('[data-services-active]');
        const refreshBtn = document.querySelector('[data-services-refresh]');
        const resetBtn = document.querySelector('[data-services-reset]');

        const numberFormatter =
          typeof Intl !== 'undefined' && typeof Intl.NumberFormat === 'function'
            ? new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' })
            : null;

        const state = {
          services: [],
          categories: [],
          isLoading: false,
          error: null,
          selectedCode: null,
          filters: {
            search: '',
            active: 'any',
            category: '',
          },
        };

        const TEXT = {
          fallbackAccount: 'Tài khoản',
          greetingFallback: 'bạn',
          summaryLoading: 'Đang tải dữ liệu dịch vụ...',
          summaryEmpty: 'Không tìm thấy dịch vụ phù hợp với bộ lọc hiện tại.',
          listLoading: 'Đang tải danh sách dịch vụ...',
          detailLoading: 'Đang tải chi tiết dịch vụ...',
          noResults: 'Không có dịch vụ nào khớp với điều kiện lọc.',
          inactiveNotice:
            'Dịch vụ đang tạm dừng tiếp nhận đăng ký. Bạn vẫn có thể xem thông tin nhưng không thể nhận mã thanh toán.',
          loginRequired:
            'Đăng nhập bằng tài khoản sinh viên hoặc giảng viên để nhận mã thanh toán cho dịch vụ này.',
          roleRestricted: 'Chỉ tài khoản sinh viên hoặc giảng viên mới có thể thực hiện đặt mua dịch vụ.',
          purchaseLoading: 'Đang tạo mã QR thanh toán...',
          purchaseMissing: 'Đã tạo yêu cầu nhưng không nhận được mã QR.',
          purchaseFailed: 'Không thể tạo mã QR. Vui lòng thử lại.',
          paymentSuccess: 'Thanh toán thành công! Cảm ơn bạn đã sử dụng dịch vụ.',
        };

        function escapeHtml(value) {
          return String(value)
            .replaceAll('&', '&amp;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;')
            .replaceAll('"', '&quot;')
            .replaceAll("'", '&#39;');
        }

        function getSession() {
          return window.HeaderManager ? window.HeaderManager.loadSession() : null;
        }

        function handleLogout() {
          if (window.HeaderManager) {
            window.HeaderManager.handleLogout();
          }
        }

        function normalizeActiveFilter(value) {
          if (!value) {
            return 'any';
          }
          const normalized = String(value).trim().toLowerCase();
          if (!normalized) {
            return 'any';
          }
          if (normalized === '1' || normalized === 'true' || normalized === 'active') {
            return 'active';
          }
          if (normalized === '0' || normalized === 'false' || normalized === 'inactive') {
            return 'inactive';
          }
          return 'any';
        }

        function initializeFiltersFromQuery() {
          const params = new URLSearchParams(window.location.search);
          const q = params.get('q') || '';
          const active = params.get('active');
          const category = params.get('category') || '';

          state.filters.search = q;
          state.filters.active = normalizeActiveFilter(active);
          state.filters.category = category;

          if (searchInput) {
            searchInput.value = state.filters.search;
          }
          if (activeSelect) {
            activeSelect.value = state.filters.active;
          }
        }

        function syncUrlWithFilters() {
          const params = new URLSearchParams();
          if (state.filters.search) {
            params.set('q', state.filters.search);
          }
          if (state.filters.active === 'active') {
            params.set('active', '1');
          } else if (state.filters.active === 'inactive') {
            params.set('active', '0');
          }
          if (state.filters.category) {
            params.set('category', state.filters.category);
          }

          const query = params.toString();
          const newUrl = query ? `${window.location.pathname}?${query}` : window.location.pathname;
          const current = `${window.location.pathname}${window.location.search}`;
          if (newUrl !== current) {
            history.replaceState({}, '', newUrl);
          }
        }

        function formatPrice(value) {
          if (value === undefined || value === null) {
            return 'Liên hệ';
          }
          const numeric = Number(value);
          if (Number.isFinite(numeric) && numberFormatter) {
            return numberFormatter.format(numeric);
          }
          if (Number.isFinite(numeric)) {
            return `${numeric.toLocaleString('vi-VN')} VND`;
          }
          return 'Liên hệ';
        }

        function formatDateTime(value) {
          if (!value) {
            return 'Chưa xác định';
          }
          const date = new Date(value);
          if (Number.isNaN(date.getTime())) {
            return 'Chưa xác định';
          }
          try {
            return date.toLocaleString('vi-VN', {
              hour12: false,
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit',
            });
          } catch (error) {
            return date.toISOString();
          }
        }

        function renderSummary() {
          if (!summaryEl) {
            return;
          }
          if (state.isLoading) {
            summaryEl.textContent = TEXT.summaryLoading;
            summaryEl.dataset.state = 'loading';
            return;
          }
          if (state.error) {
            summaryEl.textContent = state.error;
            summaryEl.dataset.state = 'error';
            return;
          }
          if (!state.services.length) {
            summaryEl.textContent = TEXT.summaryEmpty;
            summaryEl.dataset.state = 'empty';
            return;
          }
          summaryEl.innerHTML = `Đã tải <strong>${state.services.length}</strong> dịch vụ từ API.`;
          summaryEl.dataset.state = 'ready';
        }

        function renderList() {
          if (!listEl) {
            return;
          }

          listEl.innerHTML = '';

          if (state.isLoading) {
            const skeleton = document.createElement('p');
            skeleton.className = 'services-list__status';
            skeleton.textContent = TEXT.listLoading;
            listEl.appendChild(skeleton);
            return;
          }

          if (state.error) {
            const message = document.createElement('p');
            message.className = 'services-list__status';
            message.textContent = state.error;
            listEl.appendChild(message);
            return;
          }

          if (!state.services.length) {
            const empty = document.createElement('p');
            empty.className = 'services-list__status';
            empty.textContent = TEXT.noResults;
            listEl.appendChild(empty);
            return;
          }

          const session = getSession();
          const isAdmin = session && session.user && session.user.role === 'admin';

          state.services.forEach((service) => {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'service-card';
            button.dataset.serviceCard = 'true';
            button.dataset.serviceCode = service.serviceCode;
            button.setAttribute('role', 'listitem');

            const statusClass = service.isActive ? 'is-active' : 'is-inactive';
            const statusText = service.isActive ? 'Hoạt động' : 'Tạm dừng';
            const description = service.description
              ? escapeHtml(service.description)
              : 'Chưa có mô tả chi tiết cho dịch vụ này.';

            const categoryBadge = service.category
              ? `<span class="service-card__category">${escapeHtml(service.category)}</span>`
              : '';

            const editButton = isAdmin
              ? `<button type="button" class="service-card__edit-btn show" data-edit-service="${escapeHtml(service.serviceCode)}" title="Chỉnh sửa dịch vụ">✎</button>`
              : '';

            const serviceImage = service.imageUrl
              ? `<img src="${escapeHtml(service.imageUrl)}" alt="${escapeHtml(service.name)}" class="service-card__image" onerror="this.onerror=null; this.src='/img/services/placeholder-ticket.svg';" />`
              : `<img src="/img/services/placeholder-ticket.svg" alt="Service placeholder" class="service-card__image" />`;

            button.innerHTML = `
              ${editButton}
              ${serviceImage}
              <div class="service-card__header">
                <div>
                  <h3 class="service-card__title">${escapeHtml(service.name || service.serviceCode)}</h3>
                  ${categoryBadge}
                </div>
                <span class="service-card__status ${statusClass}">${escapeHtml(statusText)}</span>
              </div>
              <p class="service-card__description">${description}</p>
              <div class="service-card__meta">
                <span>Mã: ${escapeHtml(service.serviceCode)}</span>
                <span>Giá: ${escapeHtml(formatPrice(service.price))}</span>
              </div>
            `;

            if (service.serviceCode === state.selectedCode) {
              button.classList.add('is-selected');
            }

            listEl.appendChild(button);
          });
        }

        function setFeedback(element, message, type) {
          if (!element) {
            return;
          }
          element.textContent = message || '';
          element.classList.remove('success', 'error');
          if (type === 'success') {
            element.classList.add('success');
          } else if (type === 'error') {
            element.classList.add('error');
          }
        }

        function renderDetail() {
          if (!detailEl) {
            return;
          }

          detailEl.innerHTML = '';

          if (state.isLoading) {
            detailEl.innerHTML = `
              <div class="service-detail__empty">
                <div>${TEXT.detailLoading}</div>
              </div>
            `;
            return;
          }

          if (state.error) {
            detailEl.innerHTML = `
              <div class="service-detail__empty">
                <div class="service-alert">${escapeHtml(state.error)}</div>
              </div>
            `;
            return;
          }

          const service =
            state.services.find((item) => item.serviceCode === state.selectedCode) || state.services[0];

          if (!service) {
            detailEl.innerHTML = `
              <div class="service-detail__empty">
                <div>
                  <strong>Chọn một dịch vụ để xem chi tiết</strong>
                  <p>Danh sách được đồng bộ theo thời gian thực từ API dịch vụ.</p>
                </div>
              </div>
            `;
            return;
          }

          state.selectedCode = service.serviceCode;

          const statusClass = service.isActive ? 'is-active' : 'is-inactive';
          const statusText = service.isActive ? 'Hoạt động' : 'Tạm dừng';
          const description = service.description
            ? escapeHtml(service.description)
            : 'Dịch vụ chưa có mô tả chi tiết. Vui lòng liên hệ phòng dịch vụ để được hỗ trợ thêm.';

          const session = getSession();
          const isLoggedIn = Boolean(session && session.token);
          const role = session && session.user && session.user.role;
          const isAdmin = role === 'admin';
          const canPurchase = isLoggedIn && service.isActive && (role === 'teacher' || role === 'student');

          const serviceImage = service.imageUrl
            ? `<img src="${escapeHtml(service.imageUrl)}" alt="${escapeHtml(service.name)}" class="service-detail__image" onerror="this.onerror=null; this.src='/img/services/placeholder-ticket.svg';" />`
            : `<img src="/img/services/placeholder-ticket.svg" alt="Service placeholder" class="service-detail__image" />`;

          detailEl.innerHTML = `
            <header class="service-detail__header">
              <div>
                <h2 class="service-detail__title">${escapeHtml(service.name || service.serviceCode)}</h2>
                <span class="service-detail__status ${statusClass}">${escapeHtml(statusText)}</span>
              </div>
            </header>

            ${serviceImage}

            <p class="service-detail__description">${description}</p>

            <dl class="service-detail__meta">
              <div>
                <dt>Mã dịch vụ</dt>
                <dd>${escapeHtml(service.serviceCode)}</dd>
              </div>
              ${service.category ? `
              <div>
                <dt>Danh mục</dt>
                <dd>${escapeHtml(service.category)}</dd>
              </div>
              ` : ''}
              <div>
                <dt>Giá tham khảo</dt>
                <dd>${escapeHtml(formatPrice(service.price))}</dd>
              </div>
              <div>
                <dt>Ngày tạo</dt>
                <dd>${escapeHtml(formatDateTime(service.createdAt))}</dd>
              </div>
              <div>
                <dt>Cập nhật</dt>
                <dd>${escapeHtml(formatDateTime(service.updatedAt))}</dd>
              </div>
            </dl>
          `;

          if (!service.isActive) {
            const inactiveAlert = document.createElement('div');
            inactiveAlert.className = 'service-alert warning';
            inactiveAlert.textContent = TEXT.inactiveNotice;
            detailEl.appendChild(inactiveAlert);
          }

          // Don't show payment section for admin users
          if (isAdmin) {
            const adminAlert = document.createElement('div');
            adminAlert.className = 'service-alert info';
            adminAlert.textContent = 'Tài khoản quản trị không thể thực hiện thanh toán. Sử dụng trang quản trị để quản lý dịch vụ.';
            detailEl.appendChild(adminAlert);
            return;
          }

          if (!isLoggedIn) {
            const loginAlert = document.createElement('div');
            loginAlert.className = 'service-alert info';
            loginAlert.textContent = TEXT.loginRequired;
            detailEl.appendChild(loginAlert);
          } else if (role !== 'teacher' && role !== 'student') {
            const roleAlert = document.createElement('div');
            roleAlert.className = 'service-alert info';
            roleAlert.textContent = TEXT.roleRestricted;
            detailEl.appendChild(roleAlert);
          }

          const purchaseForm = document.createElement('form');
          purchaseForm.className = 'service-purchase';
          purchaseForm.setAttribute('novalidate', '');

          const formField = document.createElement('div');
          formField.className = 'services-field';
          formField.dataset.purchaseFormField = 'true';

          const label = document.createElement('label');
          label.setAttribute('for', 'service-note');
          label.textContent = 'Ghi chú bổ sung (tùy chọn)';

          const textarea = document.createElement('textarea');
          textarea.id = 'service-note';
          textarea.placeholder = 'VD: Cần hỗ trợ kích hoạt trước ngày 15/10...';
          textarea.dataset.serviceNote = 'true';
          textarea.disabled = !canPurchase;

          formField.appendChild(label);
          formField.appendChild(textarea);

          const actions = document.createElement('div');
          actions.className = 'service-purchase__actions';

          const submitBtn = document.createElement('button');
          submitBtn.type = 'submit';
          submitBtn.className = 'services-button';
          submitBtn.dataset.servicePurchase = 'true';
          submitBtn.textContent = service.isActive ? 'Nhận mã thanh toán' : 'Tạm ngừng';
          submitBtn.disabled = !canPurchase;

          const feedback = document.createElement('span');
          feedback.className = 'service-feedback';
          feedback.dataset.serviceFeedback = 'true';
          feedback.setAttribute('aria-live', 'polite');

          actions.appendChild(submitBtn);
          actions.appendChild(feedback);

          purchaseForm.appendChild(formField);
          purchaseForm.appendChild(actions);

          purchaseForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            if (!canPurchase) {
              setFeedback(feedback, TEXT.roleRestricted, 'error');
              return;
            }

            const notes = textarea.value ? textarea.value.trim() : '';

            submitBtn.disabled = true;
            setFeedback(feedback, TEXT.purchaseLoading, '');

            const session = getSession();
            if (!session || !session.token) {
              handleLogout();
              return;
            }

            try {
              const response = await fetch(
                `/api/services/${encodeURIComponent(service.serviceCode)}/purchase`,
                {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    Authorization: `Bearer ${session.token}`,
                  },
                  body: notes ? JSON.stringify({ notes }) : null,
                }
              );

              if (response.status === 401 || response.status === 403) {
                handleLogout();
                return;
              }

              if (!response.ok) {
                const payload = await response.json().catch(() => ({}));
                const message = payload && payload.error ? payload.error : `Lỗi ${response.status}`;
                throw new Error(message);
              }

              const payload = await response.json();
              const qrCodeUrl = payload && payload.qrCodeUrl ? payload.qrCodeUrl : null;
              const transactionCode = payload && payload.transactionCode ? payload.transactionCode : null;
              const bankInfo = payload && payload.bankInfo ? payload.bankInfo : {};
              const orderCode = payload && payload.orderCode ? payload.orderCode : null;

              if (qrCodeUrl && transactionCode) {
                feedback.innerHTML = '';
                feedback.classList.remove('error');
                feedback.classList.add('success');

                // An nut submit va hop ghi chu
                submitBtn.style.display = 'none';
                const formFieldEl = purchaseForm.querySelector('[data-purchase-form-field]');
                if (formFieldEl) {
                  formFieldEl.style.display = 'none';
                }

                const qrContainer = document.createElement('div');
                qrContainer.className = 'payment-qr-container';

                const header = document.createElement('div');
                header.className = 'payment-qr-header';
                header.innerHTML = `
                  <h3>Quét mã QR để thanh toán</h3>
                  <p>Sử dụng ứng dụng ngân hàng để quét mã QR bên dưới</p>
                `;

                const content = document.createElement('div');
                content.className = 'payment-qr-content';

                const imageWrapper = document.createElement('div');
                imageWrapper.className = 'payment-qr-image';
                const qrImage = document.createElement('img');
                qrImage.src = qrCodeUrl;
                qrImage.alt = 'Mã QR thanh toán';
                imageWrapper.appendChild(qrImage);

                const info = document.createElement('div');
                info.className = 'payment-qr-info';
                info.innerHTML = `
                  <div class="payment-info-item">
                    <span class="payment-info-label">Ngân hàng</span>
                    <span class="payment-info-value">${escapeHtml(bankInfo.bankName || '')}</span>
                  </div>
                  <div class="payment-info-item">
                    <span class="payment-info-label">Số tài khoản</span>
                    <span class="payment-info-value">${escapeHtml(bankInfo.bankNumber || '')}</span>
                  </div>
                  <div class="payment-info-item">
                    <span class="payment-info-label">Chủ tài khoản</span>
                    <span class="payment-info-value">${escapeHtml(bankInfo.bankOwner || '')}</span>
                  </div>
                  <div class="payment-info-item">
                    <span class="payment-info-label">Số tiền</span>
                    <span class="payment-info-value">${formatPrice(payload.amount)}</span>
                  </div>
                  <div class="payment-info-item full-width">
                    <span class="payment-info-label">Nội dung chuyển khoản</span>
                    <span class="payment-info-value highlight">${escapeHtml(transactionCode)}</span>
                  </div>
                `;

                content.appendChild(imageWrapper);
                content.appendChild(info);

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'payment-qr-actions';

                const completeBtn = document.createElement('button');
                completeBtn.type = 'button';
                completeBtn.className = 'payment-complete-btn';
                completeBtn.textContent = 'Hoàn thiện thanh toán';
                completeBtn.addEventListener('click', async () => {
                  if (!orderCode) {
                    return;
                  }

                  completeBtn.disabled = true;
                  completeBtn.textContent = 'Đang xử lý...';

                  try {
                    // Goi API de cap nhat trang thai thanh toan
                    const session = getSession();
                    const completeResponse = await fetch(`/api/orders/${orderCode}/complete`, {
                      method: 'PATCH',
                      headers: {
                        'Authorization': `Bearer ${session.token}`,
                      },
                    });

                    if (!completeResponse.ok) {
                      throw new Error('Khong the cap nhat trang thai thanh toan');
                    }

                    feedback.innerHTML = '';
                    const successMsg = document.createElement('div');
                    successMsg.className = 'payment-success-message';
                    successMsg.textContent = TEXT.paymentSuccess;
                    feedback.appendChild(successMsg);

                    setTimeout(() => {
                      feedback.innerHTML = '';
                      feedback.classList.remove('success');

                      // Hien lai nut submit va hop ghi chu
                      submitBtn.style.display = '';
                      const formFieldEl = purchaseForm.querySelector('[data-purchase-form-field]');
                      if (formFieldEl) {
                        formFieldEl.style.display = '';
                      }
                    }, 3000);
                  } catch (error) {
                    console.error('Loi hoan thien thanh toan:', error);
                    completeBtn.disabled = false;
                    completeBtn.textContent = 'Hoàn thiện thanh toán';
                    alert('Có lỗi xảy ra khi hoàn thiện thanh toán. Vui lòng thử lại.');
                  }
                });

                actionsDiv.appendChild(completeBtn);

                qrContainer.appendChild(header);
                qrContainer.appendChild(content);
                qrContainer.appendChild(actionsDiv);
                feedback.appendChild(qrContainer);

              } else {
                setFeedback(feedback, TEXT.purchaseMissing, 'error');
              }
            } catch (error) {
              setFeedback(
                feedback,
                error && error.message ? error.message : TEXT.purchaseFailed,
                'error'
              );
            } finally {
              submitBtn.disabled = false;
            }
          });

          detailEl.appendChild(purchaseForm);
        }

        function renderServices() {
          renderSummary();
          renderList();
          renderDetail();
        }

        async function fetchServices() {
          state.isLoading = true;
          state.error = null;
          renderServices();

          const params = new URLSearchParams();
          if (state.filters.search) {
            params.set('q', state.filters.search);
          }
          if (state.filters.active === 'active') {
            params.set('active', '1');
          } else if (state.filters.active === 'inactive') {
            params.set('active', '0');
          }
          if (state.filters.category) {
            params.set('category', state.filters.category);
          }

          const endpoint = params.toString() ? `/api/services?${params}` : '/api/services';

          try {
            const response = await fetch(endpoint);
            if (!response.ok) {
              throw new Error(`Không thể tải dữ liệu dịch vụ (mã ${response.status}).`);
            }

            const payload = await response.json();
            const services = Array.isArray(payload.services) ? payload.services : [];
            state.services = services;

            if (!services.length) {
              state.selectedCode = null;
            } else if (!services.some((item) => item.serviceCode === state.selectedCode)) {
              state.selectedCode = services[0].serviceCode;
            }
          } catch (error) {
            console.error('Tải dịch vụ thất bại:', error);
            state.error =
              (error && error.message) ||
              'Không thể kết nối tới API dịch vụ. Vui lòng thử lại sau ít phút.';
            state.services = [];
            state.selectedCode = null;
          } finally {
            state.isLoading = false;
            renderServices();
          }
        }

        async function fetchCategories() {
          try {
            const response = await fetch('/api/services/categories');
            if (!response.ok) {
              throw new Error('Không thể tải danh mục');
            }
            const payload = await response.json();
            state.categories = Array.isArray(payload.categories) ? payload.categories : [];
            renderCategories();
          } catch (error) {
            console.error('Lỗi tải danh mục:', error);
            state.categories = [];
            renderCategories();
          }
        }

        function renderCategories() {
          const container = document.querySelector('[data-categories-container]');
          if (!container) return;

          container.innerHTML = '';

          if (!state.categories.length) {
            container.style.display = 'none';
            return;
          }

          container.style.display = 'block';

          const wrapper = document.createElement('div');
          wrapper.className = 'services-categories__wrapper';

          // Nút "Tất cả"
          const allBtn = document.createElement('button');
          allBtn.type = 'button';
          allBtn.className = 'services-category-btn';
          allBtn.textContent = 'Tất cả';
          allBtn.dataset.category = '';
          if (!state.filters.category) {
            allBtn.classList.add('active');
          }
          wrapper.appendChild(allBtn);

          // Các category buttons
          state.categories.forEach(category => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'services-category-btn';
            btn.textContent = category;
            btn.dataset.category = category;
            if (state.filters.category === category) {
              btn.classList.add('active');
            }
            wrapper.appendChild(btn);
          });

          container.appendChild(wrapper);

          // Event listener
          wrapper.addEventListener('click', (e) => {
            const btn = e.target.closest('[data-category]');
            if (!btn) return;

            const category = btn.dataset.category;
            state.filters.category = category;

            // Update active state
            wrapper.querySelectorAll('.services-category-btn').forEach(b => {
              b.classList.toggle('active', b.dataset.category === category);
            });

            syncUrlWithFilters();
            fetchServices();
          });
        }

        function resetFilters() {
          state.filters.search = '';
          state.filters.active = 'any';
          state.filters.category = '';
          if (searchInput) {
            searchInput.value = '';
          }
          if (activeSelect) {
            activeSelect.value = 'any';
          }
          renderCategories();
        }

        function applyFilters() {
          if (searchInput) {
            state.filters.search = searchInput.value.trim();
          }
          if (activeSelect) {
            state.filters.active = normalizeActiveFilter(activeSelect.value);
            activeSelect.value = state.filters.active;
          }

          syncUrlWithFilters();
          fetchServices();
        }

        if (listEl) {
          listEl.addEventListener('click', (event) => {
            // Check if edit button was clicked
            const editBtn = event.target.closest('[data-edit-service]');
            if (editBtn) {
              event.stopPropagation();
              const serviceCode = editBtn.dataset.editService;
              openEditModal(serviceCode);
              return;
            }

            const card = event.target.closest('[data-service-card]');
            if (!card) {
              return;
            }
            const code = card.dataset.serviceCode;
            if (!code || code === state.selectedCode) {
              return;
            }
            state.selectedCode = code;
            renderServices();
          });
        }

        function openEditModal(serviceCode) {
          const service = state.services.find(s => s.serviceCode === serviceCode);
          if (!service) {
            console.error('Service not found:', serviceCode);
            return;
          }

          const modal = document.getElementById('edit-service-modal');
          if (!modal) return;

          // Populate form
          document.getElementById('edit-service-code').value = service.serviceCode;
          document.getElementById('edit-service-name').value = service.name || '';
          document.getElementById('edit-service-category').value = service.category || '';
          document.getElementById('edit-service-description').value = service.description || '';
          document.getElementById('edit-service-price').value = service.price || 0;
          document.getElementById('edit-service-active').checked = service.isActive;

          // Show existing image if available
          const editImagePreview = modal.querySelector('[data-edit-image-preview]');
          const editPreviewImg = modal.querySelector('[data-edit-preview-img]');
          if (service.imageUrl && editImagePreview && editPreviewImg) {
            editPreviewImg.src = service.imageUrl;
            editImagePreview.style.display = 'block';
          } else if (editImagePreview) {
            editImagePreview.style.display = 'none';
          }

          // Load categories for datalist
          loadCategoriesForEdit();

          // Show modal
          modal.style.display = 'flex';
          document.body.style.overflow = 'hidden';

          // Clear feedback
          const feedback = modal.querySelector('[data-edit-service-feedback]');
          if (feedback) {
            feedback.textContent = '';
            feedback.className = 'add-service-feedback';
          }
        }

        async function loadCategoriesForEdit() {
          const datalist = document.getElementById('category-datalist-edit');
          if (!datalist) return;

          try {
            const response = await fetch('/api/services/categories');
            if (!response.ok) return;

            const payload = await response.json();
            const categories = Array.isArray(payload.categories) ? payload.categories : [];

            datalist.innerHTML = '';

            categories.forEach(category => {
              const option = document.createElement('option');
              option.value = category;
              datalist.appendChild(option);
            });

            if (!categories.includes('Khác')) {
              const option = document.createElement('option');
              option.value = 'Khác';
              datalist.appendChild(option);
            }
          } catch (error) {
            console.error('Lỗi tải danh mục:', error);
          }
        }

        if (formEl) {
          formEl.addEventListener('submit', (event) => {
            event.preventDefault();
            applyFilters();
          });
        }

        if (refreshBtn) {
          refreshBtn.addEventListener('click', () => {
            fetchServices();
          });
        }

        if (resetBtn) {
          resetBtn.addEventListener('click', () => {
            resetFilters();
            syncUrlWithFilters();
            fetchServices();
            if (searchInput) {
              searchInput.focus();
            }
          });
        }

        // Show Add Service button for admin, hide Order History button for admin
        const session = getSession();
        const addServiceBtn = document.querySelector('[data-add-service-btn]');
        const orderHistoryBtn = document.querySelector('[data-order-history-btn]');

        if (session && session.user && session.user.role === 'admin') {
          if (addServiceBtn) {
            addServiceBtn.style.display = 'inline-block';
          }
          // Hide order history button for admin
          if (orderHistoryBtn) {
            orderHistoryBtn.style.display = 'none';
          }
        }

        initializeFiltersFromQuery();
        syncUrlWithFilters();
        fetchCategories();
        fetchServices();
      })();
    </script>

    <script>
      // Quan ly modal them dich vu (Admin only)
      (() => {
        const modal = document.getElementById('add-service-modal');
        const addServiceBtn = document.querySelector('[data-add-service-btn]');
        const closeBtn = modal.querySelector('[data-add-service-close]');
        const cancelBtn = modal.querySelector('[data-add-service-cancel]');
        const backdrop = modal.querySelector('[data-add-service-backdrop]');
        const form = document.getElementById('add-service-form');
        const feedback = modal.querySelector('[data-add-service-feedback]');
        const imageInput = form.querySelector('[data-image-input]');
        const imagePreview = form.querySelector('[data-image-preview]');
        const imageRemoveBtn = form.querySelector('[data-image-remove]');

        function getSession() {
          return window.HeaderManager ? window.HeaderManager.loadSession() : null;
        }

        async function openModal() {
          modal.style.display = 'flex';
          document.body.style.overflow = 'hidden';
          form.reset();
          feedback.textContent = '';
          feedback.className = 'add-service-feedback';
          imagePreview.style.display = 'none';

          // Load categories into datalist
          await loadCategories();
        }

        // Image preview handling
        if (imageInput) {
          imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = (event) => {
                const img = imagePreview.querySelector('img');
                img.src = event.target.result;
                imagePreview.style.display = 'block';
              };
              reader.readAsDataURL(file);
            }
          });
        }

        if (imageRemoveBtn) {
          imageRemoveBtn.addEventListener('click', () => {
            imageInput.value = '';
            imagePreview.style.display = 'none';
          });
        }

        async function loadCategories() {
          const datalist = document.getElementById('category-datalist');
          if (!datalist) return;

          try {
            const response = await fetch('/api/services/categories');
            if (!response.ok) {
              console.error('Không thể tải danh mục');
              return;
            }

            const payload = await response.json();
            const categories = Array.isArray(payload.categories) ? payload.categories : [];

            // Clear existing options
            datalist.innerHTML = '';

            // Add categories as options
            categories.forEach(category => {
              const option = document.createElement('option');
              option.value = category;
              datalist.appendChild(option);
            });

            // Add default "Khác" if not already there
            if (!categories.includes('Khác')) {
              const option = document.createElement('option');
              option.value = 'Khác';
              datalist.appendChild(option);
            }
          } catch (error) {
            console.error('Lỗi tải danh mục:', error);
          }
        }

        function closeModal() {
          modal.style.display = 'none';
          document.body.style.overflow = '';
        }

        if (addServiceBtn) {
          addServiceBtn.addEventListener('click', openModal);
        }

        if (closeBtn) {
          closeBtn.addEventListener('click', closeModal);
        }

        if (cancelBtn) {
          cancelBtn.addEventListener('click', closeModal);
        }

        if (backdrop) {
          backdrop.addEventListener('click', closeModal);
        }

        if (form) {
          form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const session = getSession();
            if (!session || !session.token || session.user.role !== 'admin') {
              feedback.textContent = 'Bạn không có quyền thực hiện thao tác này.';
              feedback.className = 'add-service-feedback error';
              return;
            }

            const formData = new FormData(form);
            const data = {
              name: formData.get('name'),
              category: formData.get('category'),
              description: formData.get('description'),
              price: formData.get('price') ? parseFloat(formData.get('price')) : 0,
              isActive: formData.get('isActive') === 'on',
            };

            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            feedback.textContent = 'Đang tạo dịch vụ...';
            feedback.className = 'add-service-feedback';

            try {
              const response = await fetch('/api/admin/services', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${session.token}`,
                },
                body: JSON.stringify(data),
              });

              if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error || `Lỗi ${response.status}`);
              }

              const result = await response.json();

              // Upload image if present
              const imageFile = formData.get('image');
              if (imageFile && imageFile.size > 0) {
                feedback.textContent = 'Đang upload hình ảnh...';
                try {
                  const imageFormData = new FormData();
                  imageFormData.append('image', imageFile);

                  const uploadResponse = await fetch(`/api/admin/services/${result.serviceCode}/upload-image`, {
                    method: 'POST',
                    headers: {
                      'Authorization': `Bearer ${session.token}`,
                    },
                    body: imageFormData,
                  });

                  if (!uploadResponse.ok) {
                    console.error('Upload image failed');
                  }
                } catch (uploadError) {
                  console.error('Error uploading image:', uploadError);
                }
              }

              feedback.textContent = `Đã tạo dịch vụ: ${result.serviceCode}`;
              feedback.className = 'add-service-feedback success';

              setTimeout(() => {
                closeModal();
                // Reload services list
                window.location.reload();
              }, 1500);

            } catch (error) {
              console.error('Loi tao dich vu:', error);
              feedback.textContent = error.message || 'Không thể tạo dịch vụ. Vui lòng thử lại.';
              feedback.className = 'add-service-feedback error';
            } finally {
              submitBtn.disabled = false;
            }
          });
        }

        // Dong modal khi nhan ESC
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && modal.style.display === 'flex') {
            closeModal();
          }
        });
      })();
    </script>

    <script>
      // Initialize theme toggle button
      (() => {
        const container = document.getElementById('theme-toggle-container');
        if (container && window.ThemeManager) {
          window.ThemeManager.createToggleButton(container, {
            showLabel: false,
            showDropdown: true
          });
        }
      })();
    </script>

    <script>
      // Quan ly modal lich su don hang
      (() => {
        const modal = document.getElementById('order-history-modal');
        const orderHistoryBtn = document.querySelector('[data-order-history-btn]');
        const closeBtn = modal.querySelector('[data-modal-close]');
        const backdrop = modal.querySelector('[data-modal-backdrop]');
        const orderListEl = modal.querySelector('[data-order-list]');

        function getSession() {
          return window.HeaderManager ? window.HeaderManager.loadSession() : null;
        }

        function formatDateTime(value) {
          if (!value) return 'Chưa xác định';
          const date = new Date(value);
          if (Number.isNaN(date.getTime())) return 'Chưa xác định';
          try {
            return date.toLocaleString('vi-VN', {
              hour12: false,
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit',
            });
          } catch (error) {
            return date.toISOString();
          }
        }

        function formatPrice(value) {
          if (value === undefined || value === null) return 'Liên hệ';
          const numeric = Number(value);
          if (Number.isFinite(numeric)) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(numeric);
          }
          return 'Liên hệ';
        }

        function getStatusText(status) {
          const statusMap = {
            'pending': 'Chờ thanh toán',
            'completed': 'Đã thanh toán',
            'failed': 'Thất bại',
            'cancelled': 'Đã hủy'
          };
          return statusMap[status] || status;
        }

        function openModal() {
          modal.style.display = 'flex';
          document.body.style.overflow = 'hidden';
          loadOrders();
        }

        function closeModal() {
          modal.style.display = 'none';
          document.body.style.overflow = '';
        }

        async function loadOrders() {
          const session = getSession();
          if (!session || !session.token) {
            orderListEl.innerHTML = '<div class="order-empty">Vui lòng đăng nhập để xem lịch sử đơn hàng</div>';
            return;
          }

          orderListEl.innerHTML = '<div class="order-loading">Đang tải lịch sử đơn hàng...</div>';

          try {
            const response = await fetch('/api/orders/my-orders', {
              headers: {
                'Authorization': `Bearer ${session.token}`,
              },
            });

            if (!response.ok) {
              throw new Error('Không thể tải lịch sử đơn hàng');
            }

            const data = await response.json();
            const orders = data.orders || [];

            if (!orders.length) {
              orderListEl.innerHTML = '<div class="order-empty">Bạn chưa có đơn hàng nào</div>';
              return;
            }

            orderListEl.innerHTML = orders.map(order => `
              <div class="order-item">
                <div class="order-item-header">
                  <span class="order-item-code">${order.orderCode}</span>
                  <span class="order-item-status ${order.paymentStatus}">${getStatusText(order.paymentStatus)}</span>
                </div>
                <div class="order-item-details">
                  <div class="order-item-detail">
                    <span class="order-item-label">Dịch vụ</span>
                    <span class="order-item-value">${order.serviceName || order.serviceCode}</span>
                  </div>
                  <div class="order-item-detail">
                    <span class="order-item-label">Số tiền</span>
                    <span class="order-item-value">${formatPrice(order.amount)}</span>
                  </div>
                  <div class="order-item-detail">
                    <span class="order-item-label">Mã giao dịch</span>
                    <span class="order-item-value">${order.transactionCode}</span>
                  </div>
                  <div class="order-item-detail">
                    <span class="order-item-label">Ngày tạo</span>
                    <span class="order-item-value">${formatDateTime(order.createdAt)}</span>
                  </div>
                  ${order.paidAt ? `
                    <div class="order-item-detail">
                      <span class="order-item-label">Ngày thanh toán</span>
                      <span class="order-item-value">${formatDateTime(order.paidAt)}</span>
                    </div>
                  ` : ''}
                  ${order.notes ? `
                    <div class="order-item-detail" style="grid-column: 1 / -1;">
                      <span class="order-item-label">Ghi chú</span>
                      <span class="order-item-value">${order.notes}</span>
                    </div>
                  ` : ''}
                </div>
              </div>
            `).join('');

          } catch (error) {
            console.error('Loi tai lich su don hang:', error);
            orderListEl.innerHTML = '<div class="order-empty">Có lỗi xảy ra khi tải lịch sử đơn hàng</div>';
          }
        }

        if (orderHistoryBtn) {
          orderHistoryBtn.addEventListener('click', openModal);
        }

        if (closeBtn) {
          closeBtn.addEventListener('click', closeModal);
        }

        if (backdrop) {
          backdrop.addEventListener('click', closeModal);
        }

        // Dong modal khi nhan ESC
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && modal.style.display === 'flex') {
            closeModal();
          }
        });
      })();
    </script>

    <script>
      // Quan ly modal edit dich vu (Admin only)
      (() => {
        const modal = document.getElementById('edit-service-modal');
        const closeBtn = modal.querySelector('[data-edit-service-close]');
        const cancelBtn = modal.querySelector('[data-edit-service-cancel]');
        const backdrop = modal.querySelector('[data-edit-service-backdrop]');
        const form = document.getElementById('edit-service-form');
        const feedback = modal.querySelector('[data-edit-service-feedback]');
        const imageInput = form.querySelector('[data-edit-image-input]');
        const imagePreview = form.querySelector('[data-edit-image-preview]');
        const imageRemoveBtn = form.querySelector('[data-edit-image-remove]');
        const previewImg = form.querySelector('[data-edit-preview-img]');

        function getSession() {
          return window.HeaderManager ? window.HeaderManager.loadSession() : null;
        }

        function closeModal() {
          modal.style.display = 'none';
          document.body.style.overflow = '';
        }

        // Image preview handling
        if (imageInput) {
          imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = (event) => {
                previewImg.src = event.target.result;
                imagePreview.style.display = 'block';
              };
              reader.readAsDataURL(file);
            }
          });
        }

        if (imageRemoveBtn) {
          imageRemoveBtn.addEventListener('click', () => {
            imageInput.value = '';
            imagePreview.style.display = 'none';
          });
        }

        if (closeBtn) {
          closeBtn.addEventListener('click', closeModal);
        }

        if (cancelBtn) {
          cancelBtn.addEventListener('click', closeModal);
        }

        if (backdrop) {
          backdrop.addEventListener('click', closeModal);
        }

        if (form) {
          form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const session = getSession();
            if (!session || !session.token || session.user.role !== 'admin') {
              feedback.textContent = 'Bạn không có quyền thực hiện thao tác này.';
              feedback.className = 'add-service-feedback error';
              return;
            }

            const formData = new FormData(form);
            const serviceCode = formData.get('serviceCode');
            const data = {
              name: formData.get('name'),
              category: formData.get('category'),
              description: formData.get('description'),
              price: formData.get('price') ? parseFloat(formData.get('price')) : 0,
              isActive: formData.get('isActive') === 'on',
            };

            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            feedback.textContent = 'Đang cập nhật dịch vụ...';
            feedback.className = 'add-service-feedback';

            try {
              const response = await fetch(`/api/admin/services/${encodeURIComponent(serviceCode)}`, {
                method: 'PUT',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${session.token}`,
                },
                body: JSON.stringify(data),
              });

              if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error || `Lỗi ${response.status}`);
              }

              const result = await response.json();

              // Upload image if present
              const imageFile = formData.get('image');
              if (imageFile && imageFile.size > 0) {
                feedback.textContent = 'Đang upload hình ảnh...';
                try {
                  const imageFormData = new FormData();
                  imageFormData.append('image', imageFile);

                  const uploadResponse = await fetch(`/api/admin/services/${encodeURIComponent(serviceCode)}/upload-image`, {
                    method: 'POST',
                    headers: {
                      'Authorization': `Bearer ${session.token}`,
                    },
                    body: imageFormData,
                  });

                  if (!uploadResponse.ok) {
                    console.error('Upload image failed');
                  }
                } catch (uploadError) {
                  console.error('Error uploading image:', uploadError);
                }
              }

              feedback.textContent = 'Đã cập nhật dịch vụ thành công!';
              feedback.className = 'add-service-feedback success';

              setTimeout(() => {
                closeModal();
                // Reload services list
                window.location.reload();
              }, 1500);

            } catch (error) {
              console.error('Loi cap nhat dich vu:', error);
              feedback.textContent = error.message || 'Không thể cập nhật dịch vụ. Vui lòng thử lại.';
              feedback.className = 'add-service-feedback error';
            } finally {
              submitBtn.disabled = false;
            }
          });
        }

        // Dong modal khi nhan ESC
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && modal.style.display === 'flex') {
            closeModal();
          }
        });
      })();
    </script>

    <script>
      // Presentation remote gesture support for services page
      (() => {
        let upTapCount = 0;
        let upTapTimer = null;
        let enterTapCount = 0;
        let enterTapTimer = null;
        const TAP_THRESHOLD = 500; // milliseconds

        document.addEventListener('keydown', (e) => {
          // Up arrow taps (2x = schedule, 3x = home)
          if (e.key === 'ArrowUp') {
            upTapCount++;

            if (upTapTimer) {
              clearTimeout(upTapTimer);
            }

            // Triple tap = home
            if (upTapCount === 3) {
              e.preventDefault();
              window.location.href = '/home';
              upTapCount = 0;
              return;
            }

            // Double tap = schedule
            if (upTapCount === 2) {
              e.preventDefault();
              // Wait a bit to see if there's a 3rd tap
              upTapTimer = setTimeout(() => {
                if (upTapCount === 2) {
                  window.location.href = '/schedule';
                }
                upTapCount = 0;
              }, TAP_THRESHOLD);
              return;
            }

            // First tap, wait for more
            upTapTimer = setTimeout(() => {
              upTapCount = 0;
            }, TAP_THRESHOLD);
          }

          // Enter taps (2x = theme)
          if (e.key === 'Enter') {
            enterTapCount++;

            if (enterTapTimer) {
              clearTimeout(enterTapTimer);
            }

            // Double tap = theme
            if (enterTapCount === 2) {
              e.preventDefault();
              if (window.ThemeManager && typeof window.ThemeManager.cycleTheme === 'function') {
                window.ThemeManager.cycleTheme();
              }
              enterTapCount = 0;
              return;
            }

            // First tap, wait for more
            enterTapTimer = setTimeout(() => {
              enterTapCount = 0;
            }, TAP_THRESHOLD);
          }
        });
      })();
    </script>
  </body>
</html>

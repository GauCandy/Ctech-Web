<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CTECH | Cổng thông tin</title>
    <link rel="icon" type="image/webp" href="/img/logo.webp" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/css/main.css" />
    <link rel="stylesheet" href="/css/enhancements.css" />
    <link rel="stylesheet" href="/css/floating-buttons.css" />
    <link rel="stylesheet" href="/css/loader.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <script src="/js/themeManager.js"></script>
  </head>
  <body>
    <div id="app-loader" class="loader-backdrop" aria-hidden="true">
      <div class="loader-logo">
        <img src="/img/logo.webp" alt="Logo CTECH" />
      </div>
    </div>

    <header class="site-header">
      <div class="header-inner container">
        <a class="brand" href="#gioi-thieu" aria-label="Trang chủ CTECH">
          <img src="/img/logo.webp" alt="Logo CTECH" />
        </a>
        <div class="header-actions">
          <nav class="nav-links" aria-label="Điều hướng chính">
            <a href="/">Trang chủ</a>
            <a href="#tai-sao-chon-ctech">Giới thiệu</a>
            <a href="#chuong-trinh">Chương trình</a>
            <a href="#doi-song">Đời sống</a>
            <a href="/services">Dịch vụ</a>
            <a href="/schedule">Lịch trình</a>
            <a href="#tin-tuc">Tin tức</a>
          </nav>
          <div id="theme-toggle-container"></div>
          <div class="user-indicator" data-user-indicator>
            <a class="user-link" href="/login">Đăng nhập</a>
          </div>
        </div>
      </div>
    </header>

    <main class="site-main">
      <section class="hero" id="gioi-thieu">
        <div class="hero-content container">
          <div class="hero-highlights" role="list">
            <article class="highlight-card" role="listitem">
              <span class="highlight-metric">15+</span>
              <div class="highlight-content">
                <strong>Hành trình phát triển</strong>
                <p>Hơn 15 năm đồng hành cùng cộng đồng kỹ sư trẻ trên cả nước.</p>
              </div>
            </article>
            <article class="highlight-card" role="listitem">
              <span class="highlight-metric">100%</span>
              <div class="highlight-content">
                <strong>Sinh viên có việc làm</strong>
                <p>100% sinh viên tốt nghiệp làm việc đúng chuyên môn tại doanh nghiệp đối tác.</p>
              </div>
            </article>
            <article class="highlight-card" role="listitem">
              <span class="highlight-metric">25+</span>
              <div class="highlight-content">
                <strong>Ngành học chuyên sâu</strong>
                <p>Danh mục ngành học phong phú, chú trọng thực hành và đổi mới sáng tạo.</p>
              </div>
            </article>
            <article class="highlight-card" role="listitem">
              <span class="highlight-metric">500</span>
              <div class="highlight-content">
                <strong>Đối tác doanh nghiệp</strong>
                <p>Mạng lưới doanh nghiệp đa lĩnh vực cùng tham gia đào tạo và tuyển dụng.</p>
              </div>
            </article>
          </div>
          <div class="hero-intro">
            <h1>Xây dựng tương lai với CTECH</h1>
            <p>
              CTECH mang đến môi trường đào tạo kỹ thuật bền vững với chương trình cập nhật xu hướng 4.0, cơ sở vật
              chất hiện đại và mạng lưới đối tác doanh nghiệp rộng khắp để sinh viên sẵn sàng hội nhập ngay khi ra trường.
            </p>
            <div class="hero-actions">
              <a class="btn-secondary" href="#chuong-trinh">Khám phá chương trình</a>
            </div>
          </div>
        </div>
      </section>

      <section class="section section-about" id="tai-sao-chon-ctech">
        <div class="about-container">
          <div class="about-header">
            <div class="about-badge">CTECH</div>
            <h2 class="about-main-title">Tại sao chọn CTECH</h2>
            <div class="about-intro-box">
              <h3>Trường Cao đẳng Kỹ thuật - Công nghệ Bách Khoa</h3>
              <p class="about-meta">
                <strong>Mã trường: CCG</strong> • Thành lập <strong>01/10/2008</strong>
              </p>
              <p class="about-description">
                Được thành lập bởi các giáo sư và tiến sĩ của Đại học Bách Khoa Hà Nội, CTECH là cơ sở giáo dục nghề nghiệp
                uy tín, hướng đến mục tiêu trang bị toàn diện cho sinh viên về kiến thức chuyên môn, kỹ năng nghề nghiệp và
                hiểu biết xã hội, giúp họ tự tin hòa nhập thị trường lao động trong nước và quốc tế.
              </p>
            </div>
          </div>

          <div class="about-5c-section">
            <div class="about-5c-title">
              <span class="c5-badge">5C</span>
              <h3>Mô hình trường thực nghiệm chuẩn 5C</h3>
              <p>CTECH chú trọng đào tạo kiến thức, tay nghề và rèn luyện kỹ năng mềm, giúp sinh viên tự tin hội nhập và phát triển bền vững</p>
            </div>

            <div class="c5-grid">
              <article class="c5-card c5-card--1">
                <div class="c5-number">01</div>
                <div class="c5-icon">
                  <span class="material-icons">school</span>
                </div>
                <h4>Chất lượng giảng dạy</h4>
                <p>Đội ngũ giảng viên giỏi chuyên môn từ các doanh nghiệp lớn, mang kinh nghiệm thực tế cho sinh viên</p>
              </article>

              <article class="c5-card c5-card--2">
                <div class="c5-number">02</div>
                <div class="c5-icon">
                  <span class="material-icons">apartment</span>
                </div>
                <h4>Cơ sở vật chất hiện đại</h4>
                <p>Phòng học, phòng thí nghiệm và xưởng thực hành đạt tiêu chuẩn quốc tế</p>
              </article>

              <article class="c5-card c5-card--3">
                <div class="c5-number">03</div>
                <div class="c5-icon">
                  <span class="material-icons">work</span>
                </div>
                <h4>Chương trình thực tiễn</h4>
                <p>Tiếp cận dự án thực tế, ứng dụng kiến thức ngay trong quá trình học</p>
              </article>

              <article class="c5-card c5-card--4">
                <div class="c5-number">04</div>
                <div class="c5-icon">
                  <span class="material-icons">handshake</span>
                </div>
                <h4>Doanh nghiệp hợp tác</h4>
                <p>Mạng lưới liên kết với các tập đoàn lớn, cơ hội thực tập và việc làm</p>
              </article>

              <article class="c5-card c5-card--5">
                <div class="c5-number">05</div>
                <div class="c5-icon">
                  <span class="material-icons">public</span>
                </div>
                <h4>Hội nhập quốc tế</h4>
                <p>Hợp tác với trường đại học, tổ chức quốc tế, chương trình liên thông và làm việc nước ngoài</p>
              </article>
            </div>
          </div>
        </div>
      </section>

      <section class="section" id="chuong-trinh">
        <div class="section-inner container">
          <div class="section-heading">
            <h2 class="section-title">Chương trình đào tạo</h2>
            <p class="section-subtitle">
              Lộ trình học được xây dựng linh hoạt, kết hợp lý thuyết và thực hành nhằm trang bị năng lực nghề nghiệp
              vững vàng cho sinh viên.
            </p>
          </div>
          <div class="program-grid">
            <article class="card">
              <h3>Công nghệ thông tin</h3>
              <p>Chuyên sâu lập trình, phát triển phần mềm, trí tuệ nhân tạo và an toàn thông tin với phòng lab hiện đại.</p>
            </article>
            <article class="card">
              <h3>Điện - Điện tử - Tự động hóa</h3>
              <p>Thực hành với hệ thống tự động hóa, robot công nghiệp và giải pháp điều khiển thông minh.</p>
            </article>
            <article class="card">
              <h3>Thiết kế đa phương tiện</h3>
              <p>Kết hợp mỹ thuật và công nghệ trong thiết kế giao diện, nhận diện thương hiệu và sản phẩm số.</p>
            </article>
            <article class="card">
              <h3>Logistics & Chuỗi cung ứng</h3>
              <p>Đào tạo quản lý vận hành, tối ưu chuỗi cung ứng với sự đồng hành của doanh nghiệp đối tác.</p>
            </article>
          </div>
        </div>
      </section>

      <section class="section" id="doi-song">
        <div class="section-inner container">
          <div class="section-heading">
            <h2 class="section-title">Đời sống CTECH</h2>
            <p class="section-subtitle">
              Không gian học tập xanh – sáng tạo – trách nhiệm giúp sinh viên phát triển toàn diện kỹ năng chuyên môn và
              kỹ năng mềm.
            </p>
          </div>
          <div class="campus-grid">
            <article class="card">
              <h3>Cơ sở vật chất</h3>
              <p>Hệ thống phòng học tiêu chuẩn, xưởng thực hành, trung tâm dữ liệu và thư viện số luôn sẵn sàng phục vụ.</p>
            </article>
            <article class="card">
              <h3>Câu lạc bộ & hoạt động</h3>
              <p>Hơn 25 câu lạc bộ về công nghệ, khởi nghiệp, nghệ thuật, tình nguyện giúp sinh viên kết nối và phát triển.</p>
            </article>
            <article class="card">
              <h3>Kết nối doanh nghiệp</h3>
              <p>Mentoring, talkshow, workshop và chương trình thực tập thực tế cùng chuyên gia trong ngành.</p>
            </article>
          </div>
        </div>
      </section>

      <section class="section" id="dich-vu">
        <div class="section-inner container">
          <div class="section-heading">
            <h2 class="section-title">Cổng dịch vụ trực tuyến</h2>
            <p class="section-subtitle">
              Khám phá trang chuyên biệt để tương tác với API dịch vụ, tra cứu thông tin và nhận mã thanh toán.
              <br />
              <a href="/api/services" target="_blank" rel="noopener">Mở dữ liệu JSON tại /api/services</a>
            </p>
            <div class="hero-actions">
              <a class="btn-secondary" href="/services">Mở trang dịch vụ</a>
            </div>
          </div>
          <div class="services-grid">
            <article class="card">
              <h3>Tra cứu theo thời gian thực</h3>
              <p>Dữ liệu đồng bộ trực tiếp từ API giúp bạn tìm kiếm theo mã, tên và trạng thái hoạt động.</p>
            </article>
            <article class="card">
              <h3>Tương tác bảo mật</h3>
              <p>Đăng nhập bằng tài khoản sinh viên hoặc giảng viên để nhận mã thanh toán hợp lệ.</p>
            </article>
            <article class="card">
              <h3>Giao diện thân thiện</h3>
              <p>Xem mô tả chi tiết, giá và lịch sử cập nhật của từng dịch vụ trên một trang riêng biệt.</p>
            </article>
          </div>
        </div>
      </section>

      <section class="section" id="tin-tuc">
        <div class="section-inner container">
          <div class="section-heading">
            <h2 class="section-title">Tin tức & Sự kiện</h2>
            <p class="section-subtitle">
              Cập nhật các sự kiện nổi bật, hoạt động kết nối và thành tựu của cộng đồng CTECH.
            </p>
          </div>
          <div class="news-grid">
            <article class="card news-card">
              <time datetime="2025-10-08">08/10/2025</time>
              <h3>Ký kết hợp tác cùng Tập đoàn TechGroup</h3>
              <p>Thỏa thuận chiến lược về học bổng, chương trình thực tập và không gian làm việc chung cho sinh viên.</p>
            </article>
            <article class="card news-card">
              <time datetime="2025-09-30">30/09/2025</time>
              <h3>Hackathon “Green Future 2025”</h3>
              <p>48 giờ tranh tài tìm kiếm giải pháp công nghệ xanh với sự cố vấn của chuyên gia đầu ngành.</p>
            </article>
            <article class="card news-card">
              <time datetime="2025-09-15">15/09/2025</time>
              <h3>Chào đón tân sinh viên 2025</h3>
              <p>Tuần lễ định hướng với chuỗi hoạt động trải nghiệm và khám phá cơ sở vật chất tại CTECH.</p>
            </article>
          </div>
        </div>
      </section>
    </main>

    <footer class="site-footer" id="contact">
      <div class="footer-inner container">
        <div class="footer-columns">
          <div>
            <h4>Trụ sở chính</h4>
            <p>60 Quốc lộ 1A, xã Tân Phước Khánh, thành phố Hà Nội</p>
          </div>
          <div>
            <h4>Cơ sở đào tạo</h4>
            <p>57 Cách Mạng Tháng Tám, phường Bình Thủy, TP Cần Thơ</p>
          </div>
          <div>
            <h4>Văn phòng tuyển sinh</h4>
            <p>
              60 Quốc lộ 1A, Hà Nội<br />
              102 Phùng Hưng, phường Đồng Ba, Huế<br />
              19 Trần Thái Dự, quận Hoàng Mai, Hà Nội<br />
              57 Cách Mạng Tháng Tám, phường Bình Thủy, Cần Thơ
            </p>
          </div>
        </div>
        <div class="footer-contact">
          <span>Tổng đài tư vấn: <a href="tel:18006770">1800 6770</a></span>
          <span>Email: <a href="mailto:contact@ctech.edu.vn">contact@ctech.edu.vn</a></span>
        </div>
      </div>
    </footer>

    <button class="help-floating" type="button" data-chat-toggle aria-label="Cần trợ giúp?">
      <span class="material-icons" aria-hidden="true">contact_support</span>
      <span>Cần trợ giúp?</span>
    </button>

    <button class="back-to-top" type="button" data-back-to-top aria-label="Về đầu trang" hidden>
      <span class="material-icons" aria-hidden="true">arrow_upward</span>
    </button>

    <section class="chat-widget" data-chat-root aria-hidden="true" hidden>
      <div class="chat-widget__panel" role="dialog" aria-modal="true" aria-labelledby="chat-widget-title">
        <header class="chat-widget__header">
          <div class="chat-widget__profile">
            <span class="chat-widget__avatar" aria-hidden="true">
              <img src="/img/help.webp" alt="Tong dai ho tro CTECH" />
            </span>
            <div class="chat-widget__identity">
              <h2 id="chat-widget-title">CTECH Assistant</h2>
              <span class="chat-widget__presence">
                Đang trực tuyến
                <span class="chat-widget__presence-indicator" aria-hidden="true"></span>
              </span>
            </div>
          </div>
          <div class="chat-widget__actions">
            <button class="chat-widget__theme-toggle" type="button" data-theme-toggle aria-label="Chuyển chế độ tối/sáng" title="Chuyển chế độ">
              <span class="material-icons" aria-hidden="true" data-theme-icon>dark_mode</span>
            </button>
            <button class="chat-widget__expand" type="button" data-chat-expand aria-label="Mở rộng khung trò chuyện">
              <span class="material-icons" aria-hidden="true" data-expand-icon>open_in_full</span>
            </button>
            <button class="chat-widget__close" type="button" data-chat-close aria-label="Đóng hộp trò chuyện">
              <span class="material-icons" aria-hidden="true">close</span>
            </button>
          </div>
        </header>
        <div class="chat-widget__messages" data-chat-messages role="log" aria-live="polite" aria-relevant="additions">
          <button class="chat-widget__scroll-bottom" data-scroll-bottom aria-label="Cuộn xuống cuối">
            <span class="material-icons" aria-hidden="true">keyboard_arrow_down</span>
          </button>
        </div>
        <form class="chat-widget__form" data-chat-form novalidate>
          <label class="chat-widget__label" for="chatMessage">Tin nhắn của bạn</label>
          <div class="chat-widget__composer">
            <textarea
              class="chat-widget__input"
              id="chatMessage"
              name="message"
              rows="1"
              placeholder="You message"
              data-chat-input
              required
            ></textarea>
            <button class="chat-widget__send" type="submit" data-chat-send aria-label="Gửi tin nhắn">
              <span class="material-icons" aria-hidden="true">send</span>
            </button>
          </div>
        </form>
      </div>
    </section>

    <script>
      (() => {
        const root = document.querySelector('[data-chat-root]');
        const toggle = document.querySelector('[data-chat-toggle]');
        if (!root || !toggle) {
          return;
        }

        const closeBtn = root.querySelector('[data-chat-close]');
        const expandBtn = root.querySelector('[data-chat-expand]');
        const expandIcon = expandBtn ? expandBtn.querySelector('[data-expand-icon]') : null;
        const themeToggleBtn = root.querySelector('[data-theme-toggle]');
        const themeIcon = themeToggleBtn ? themeToggleBtn.querySelector('[data-theme-icon]') : null;
        const scrollBottomBtn = root.querySelector('[data-scroll-bottom]');
        const form = root.querySelector('[data-chat-form]');
        const input = root.querySelector('[data-chat-input]');
        const messageList = root.querySelector('[data-chat-messages]');
        const panel = root.querySelector('.chat-widget__panel');
        const sendBtn = root.querySelector('[data-chat-send]');
        const history = [];
        const maxHistory = 20;
        const greetingMessage =
          'Xin chào! Tôi là BotChat của CTECH. Tôi có thể hỗ trợ bạn với thông tin tuyển sinh, học phí và các dịch vụ của trường.\nBạn có thể bắt đầu với một số câu hỏi phổ biến dưới đây:';
        const suggestedPrompts = [
          'Các dịch vụ nổi bật của trường CTECH',
          'Học phí và chính sách hỗ trợ tài chính',
          'Quy trình tuyển sinh tại CTECH',
        ];
        let hasInitialized = false;
        let suggestionContainer = null;
        let isOpen = false;
        let isBusy = false;
        let isExpanded = false;
        let lastTouchY = null;

        function escapeHtml(value) {
          return String(value)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
        }

        function applyInlineFormatting(source) {
          return source
            .replace(/(?<!\\)`([^`]+?)`/g, '<code>$1</code>')
            .replace(/(?<!\\)\*\*(.+?)\*\*/g, '<strong>$1</strong>')
            .replace(/(?<!\\)\*(?!\*)(.+?)(?<!\*)\*(?!\*)/g, '<em>$1</em>')
            .replace(/(?<!\\)__(.+?)__/g, '<strong>$1</strong>')
            .replace(/(?<!\\)_(.+?)_/g, '<em>$1</em>')
            .replace(/(?<!\\)\[(.+?)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>')
            .replace(/\\([*_`\\])/g, '$1');
        }

        function renderStructuredText(raw) {
          const escaped = escapeHtml(raw);
          const lines = escaped.split(/\r?\n/);
          const parts = [];
          let pendingParagraph = [];
          let listType = null;

          const flushParagraph = () => {
            if (pendingParagraph.length) {
              parts.push('<p>' + pendingParagraph.join('<br />') + '</p>');
              pendingParagraph = [];
            }
          };

          const closeList = () => {
            if (listType === 'ul') {
              parts.push('</ul>');
            } else if (listType === 'ol') {
              parts.push('</ol>');
            }
            listType = null;
          };

          lines.forEach((line) => {
            const trimmed = line.trim();
            const bulletMatch = /^[-•]\s+(.+)$/.exec(trimmed);
            const orderedMatch = /^[0-9]+\.\s+(.+)$/.exec(trimmed);

            if (bulletMatch) {
              flushParagraph();
              if (listType !== 'ul') {
                closeList();
                parts.push('<ul>');
                listType = 'ul';
              }
              parts.push('<li>' + applyInlineFormatting(bulletMatch[1]) + '</li>');
              return;
            }

            if (orderedMatch) {
              flushParagraph();
              if (listType !== 'ol') {
                closeList();
                parts.push('<ol>');
                listType = 'ol';
              }
              parts.push('<li>' + applyInlineFormatting(orderedMatch[1]) + '</li>');
              return;
            }

            if (trimmed === '') {
              flushParagraph();
              closeList();
              parts.push('<br />');
              return;
            }

            closeList();
            pendingParagraph.push(applyInlineFormatting(line));
          });

          flushParagraph();
          closeList();

          return parts.join('');
        }

        function renderRichContent(raw) {
          if (raw === null || raw === undefined) {
            return '';
          }
          const text = String(raw);
          if (!text) {
            return '';
          }
          const segments = text.split(/```([\s\S]*?)```/);
          const htmlParts = [];

          segments.forEach((segment, index) => {
            if (index % 2 === 1) {
              const codeBlock = escapeHtml(segment.replace(/^\n+|\n+$/g, ''));
              htmlParts.push(
                '<pre><code>' + codeBlock + '</code></pre>'
              );
            } else if (segment) {
              const structured = renderStructuredText(segment);
              if (structured) {
                htmlParts.push(structured);
              }
            }
          });

          return htmlParts.join('').replace(/(?:<br \/>){2,}/g, '<br /><br />');
        }

        root.dataset.state = 'closed';
        toggle.setAttribute('aria-expanded', 'false');
        toggle.setAttribute('aria-haspopup', 'dialog');

        // Sync with global theme manager
        function updateThemeIcon() {
          if (!themeIcon || !window.ThemeManager) return;
          const currentThemeInfo = window.ThemeManager.getThemeInfo();
          themeIcon.textContent = currentThemeInfo.icon;
        }

        // Initialize theme icon
        updateThemeIcon();

        // Listen for theme changes from global theme manager
        if (window.ThemeManager) {
          window.ThemeManager.subscribe((theme, themeInfo) => {
            updateThemeIcon();
          });
        }

        // Typing indicator functions
        function showTypingIndicator() {
          if (!messageList) return;
          const indicator = document.createElement('div');
          indicator.className = 'chat-widget__typing-indicator';
          indicator.setAttribute('data-typing-indicator', '');
          indicator.innerHTML = `
            <span class="chat-widget__typing-meta">BotChat</span>
            <div class="chat-widget__typing-bubble">
              <div class="chat-widget__typing-dot"></div>
              <div class="chat-widget__typing-dot"></div>
              <div class="chat-widget__typing-dot"></div>
            </div>
          `;
          messageList.appendChild(indicator);
          messageList.scrollTop = messageList.scrollHeight;
        }

        function hideTypingIndicator() {
          const indicator = messageList?.querySelector('[data-typing-indicator]');
          if (indicator) {
            indicator.remove();
          }
        }

        // Scroll to bottom functions
        function updateScrollButton() {
          if (!messageList || !scrollBottomBtn) return;
          const isNearBottom = messageList.scrollHeight - messageList.scrollTop - messageList.clientHeight < 100;
          if (isNearBottom) {
            scrollBottomBtn.classList.remove('visible');
          } else {
            scrollBottomBtn.classList.add('visible');
          }
        }

        function scrollToBottom(smooth = true) {
          if (!messageList) return;
          messageList.scrollTo({
            top: messageList.scrollHeight,
            behavior: smooth ? 'smooth' : 'auto'
          });
        }

        // Copy code function
        function setupCodeCopyButtons(bubble) {
          const codeBlocks = bubble.querySelectorAll('pre');
          codeBlocks.forEach((pre) => {
            if (pre.querySelector('.chat-widget__code-header')) return;

            const code = pre.querySelector('code');
            if (!code) return;

            const header = document.createElement('div');
            header.className = 'chat-widget__code-header';

            const copyBtn = document.createElement('button');
            copyBtn.type = 'button';
            copyBtn.className = 'chat-widget__copy-btn';
            copyBtn.innerHTML = '<span class="material-icons">content_copy</span><span>Copy</span>';

            copyBtn.addEventListener('click', async () => {
              try {
                await navigator.clipboard.writeText(code.textContent || '');
                copyBtn.classList.add('copied');
                copyBtn.innerHTML = '<span class="material-icons">check</span><span>Copied!</span>';
                setTimeout(() => {
                  copyBtn.classList.remove('copied');
                  copyBtn.innerHTML = '<span class="material-icons">content_copy</span><span>Copy</span>';
                }, 2000);
              } catch (err) {
                console.error('Failed to copy:', err);
              }
            });

            header.appendChild(copyBtn);
            pre.insertBefore(header, pre.firstChild);
          });
        }

        function shouldLockScroll(target, deltaY) {
          if (!target) {
            return false;
          }
          const { scrollTop, scrollHeight, clientHeight } = target;
          if (deltaY < 0 && scrollTop <= 0) {
            return true;
          }
          if (deltaY > 0 && scrollTop + clientHeight >= scrollHeight) {
            return true;
          }
          return false;
        }

        function updateExpandUI() {
          if (!expandBtn) {
            return;
          }
          if (isExpanded) {
            expandBtn.setAttribute('aria-label', 'Thu nh? khung tr? chuy?n');
            expandBtn.setAttribute('aria-pressed', 'true');
            if (expandIcon) {
              expandIcon.textContent = 'close_fullscreen';
            }
            expandBtn.classList.add('is-active');
          } else {
            expandBtn.setAttribute('aria-label', 'M? r?ng khung tr? chuy?n');
            expandBtn.setAttribute('aria-pressed', 'false');
            if (expandIcon) {
              expandIcon.textContent = 'open_in_full';
            }
            expandBtn.classList.remove('is-active');
          }
        }

        function updateExpandState(next) {
          const nextValue = Boolean(next);
          if (nextValue === isExpanded) {
            if (!isExpanded) {
              updateExpandUI();
            }
            return;
          }
          isExpanded = nextValue;
          if (isExpanded) {
            root.dataset.view = 'expanded';
          } else {
            delete root.dataset.view;
          }
          updateExpandUI();
        }

        updateExpandUI();

        function clearSuggestions() {
          if (suggestionContainer) {
            suggestionContainer.remove();
            suggestionContainer = null;
          }
        }

        function handleSuggestionClick(prompt) {
          if (!prompt) {
            return;
          }
          if (input) {
            input.value = prompt;
          }
          clearSuggestions();
          sendMessage(prompt);
        }

        function appendMessage(role, content, options = {}) {
          if (!messageList) {
            return;
          }
          const wrapper = document.createElement('div');
          wrapper.className = 'chat-widget__message chat-widget__message--' + role;
          const now = new Date();

          const meta = document.createElement('span');
          meta.className = 'chat-widget__meta';
          meta.innerHTML = role === 'user'
            ? '<span class="material-icons" style="font-size: 12px;">person</span> Bạn'
            : '<span class="material-icons" style="font-size: 12px;">smart_toy</span> BotChat';

          const bubble = document.createElement('div');
          bubble.className = 'chat-widget__bubble';
          if (options.html === true) {
            bubble.innerHTML = typeof content === 'string' ? content : String(content || '');
          } else {
            bubble.innerHTML = renderRichContent(content);
          }

          // Setup copy buttons for code blocks
          if (role === 'assistant') {
            setupCodeCopyButtons(bubble);
          }

          const timestamp = document.createElement('time');
          timestamp.className = 'chat-widget__time';
          timestamp.dateTime = now.toISOString();
          timestamp.textContent = now.toLocaleTimeString('vi-VN', {
            hour: '2-digit',
            minute: '2-digit',
          });

          wrapper.appendChild(meta);
          wrapper.appendChild(bubble);
          if (role === 'assistant' && Array.isArray(options.suggestions) && options.suggestions.length) {
            clearSuggestions();
            const suggestions = document.createElement('div');
            suggestions.className = 'chat-widget__suggestions';
            options.suggestions.forEach((prompt) => {
              const button = document.createElement('button');
              button.type = 'button';
              button.className = 'chat-widget__suggestion';
              button.textContent = prompt;
              button.addEventListener('click', () => {
                handleSuggestionClick(prompt);
              });
              suggestions.appendChild(button);
            });
            wrapper.appendChild(suggestions);
            suggestionContainer = suggestions;
          }
          wrapper.appendChild(timestamp);
          messageList.appendChild(wrapper);
          scrollToBottom();
          updateScrollButton();
        }

        function initializeChatIfNeeded() {
          if (hasInitialized) {
            return;
          }
          hasInitialized = true;
          appendMessage('assistant', greetingMessage, { suggestions: suggestedPrompts });
          history.push({ role: 'assistant', content: greetingMessage });
          if (history.length > maxHistory) {
            history.splice(0, history.length - maxHistory);
          }
        }

        function toggleChat(forceOpen) {
          const next = typeof forceOpen === 'boolean' ? forceOpen : !isOpen;
          if (next === isOpen) {
            if (next && input) {
              input.focus();
            }
            return;
          }
          isOpen = next;
          if (isOpen) {
            root.hidden = false;
            root.setAttribute('aria-hidden', 'false');
            if (panel) {
              root.dataset.state = 'closed';
              void panel.offsetWidth;
            }
            root.dataset.state = 'opening';
            requestAnimationFrame(() => {
              root.dataset.state = 'open';
            });
            if (toggle) {
              toggle.setAttribute('aria-expanded', 'true');
              toggle.classList.add('is-hidden');
              toggle.setAttribute('aria-hidden', 'true');
              toggle.setAttribute('tabindex', '-1');
            }
            updateExpandUI();
            initializeChatIfNeeded();
            if (input) {
              requestAnimationFrame(() => input.focus());
            }
          } else {
            root.dataset.state = 'closing';
            root.setAttribute('aria-hidden', 'true');
            const finalizeClose = () => {
              root.hidden = true;
              root.dataset.state = 'closed';
              updateExpandState(false);
              if (toggle) {
                toggle.classList.remove('is-hidden');
                toggle.removeAttribute('aria-hidden');
                toggle.removeAttribute('tabindex');
                toggle.setAttribute('aria-expanded', 'false');
                toggle.focus();
              }
            };
            if (panel) {
              panel.addEventListener(
                'transitionend',
                finalizeClose,
                { once: true }
              );
            } else {
              finalizeClose();
            }
          }
        }

        async function sendMessage(rawText) {
          const message = rawText.trim();
          if (!message) {
            return;
          }

          clearSuggestions();
          appendMessage('user', message);
          history.push({ role: 'user', content: message });
          if (history.length > maxHistory) {
            history.splice(0, history.length - maxHistory);
          }

          if (input) {
            input.value = '';
            input.focus();
          }

          isBusy = true;
          if (sendBtn) {
            sendBtn.disabled = true;
          }

          // Show typing indicator
          showTypingIndicator();

          try {
            const response = await fetch('/api/chatbot/chat', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                message,
                history: history.slice(-10),
              }),
            });

            let payload = null;
            const contentType = response.headers.get('content-type') || '';
            if (contentType.includes('application/json')) {
              payload = await response.json();
            } else {
              const fallbackText = await response.text();
              payload = fallbackText ? { reply: fallbackText } : null;
            }

            // Hide typing indicator
            hideTypingIndicator();

            if (!response.ok) {
              throw { status: response.status, payload };
            }

            const reply = payload && typeof payload.reply === 'string' ? payload.reply.trim() : '';
            if (reply) {
              history.push({ role: 'assistant', content: reply });
              if (history.length > maxHistory) {
                history.splice(0, history.length - maxHistory);
              }
              appendMessage('assistant', reply);
            } else {
              appendMessage('assistant', 'BotChat chưa có phản hồi. Vui lòng thử lại sau.');
            }
          } catch (error) {
            // Hide typing indicator on error
            hideTypingIndicator();

            let detail = '';
            if (error && error.payload && typeof error.payload === 'object' && error.payload.error) {
              detail = ': ' + String(error.payload.error);
            }
            const statusText = error && error.status ? ' (mã ' + error.status + ')' : '';
            appendMessage('assistant', 'Xin lỗi, hệ thống đang gặp sự cố' + statusText + detail + '.');
          } finally {
            isBusy = false;
            if (sendBtn) {
              sendBtn.disabled = false;
            }
          }
        }

        toggle.addEventListener('click', () => {
          toggleChat();
        });

        if (themeToggleBtn && window.ThemeManager) {
          themeToggleBtn.addEventListener('click', () => {
            window.ThemeManager.cycleTheme();
          });
        }

        if (scrollBottomBtn) {
          scrollBottomBtn.addEventListener('click', () => {
            scrollToBottom(true);
          });
        }

        if (messageList) {
          messageList.addEventListener('scroll', () => {
            updateScrollButton();
          });
        }

        if (expandBtn) {
          expandBtn.addEventListener('click', () => {
            const nextExpanded = !isExpanded;
            updateExpandState(nextExpanded);
            if (nextExpanded && !isOpen) {
              toggleChat(true);
            }
            if (nextExpanded && input) {
              requestAnimationFrame(() => input.focus());
            }
          });
        }

        if (closeBtn) {
          closeBtn.addEventListener('click', () => {
            toggleChat(false);
          });
        }

        root.addEventListener('click', (event) => {
          if (event.target === root) {
            toggleChat(false);
          }
        });

        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape' && isOpen) {
            if (isExpanded) {
              updateExpandState(false);
              return;
            }
            toggleChat(false);
          }
        });

        if (form && input) {
          form.addEventListener('submit', (event) => {
            event.preventDefault();
            if (isBusy) {
              return;
            }
            sendMessage(input.value || '');
          });

          input.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
              if (event.shiftKey) {
                return;
              }
              event.preventDefault();
              if (!isBusy) {
                sendMessage(input.value || '');
              }
            }
          });
        }

        if (messageList) {
          messageList.addEventListener(
            'wheel',
            (event) => {
              if (shouldLockScroll(messageList, event.deltaY)) {
                event.preventDefault();
              }
              event.stopPropagation();
            },
            { passive: false }
          );

          messageList.addEventListener(
            'touchstart',
            (event) => {
              if (event.touches && event.touches.length === 1) {
                lastTouchY = event.touches[0].clientY;
              }
            },
            { passive: true }
          );

          const handleTouchMove = (event) => {
            if (!event.touches || event.touches.length !== 1 || lastTouchY === null) {
              return;
            }
            const currentY = event.touches[0].clientY;
            const deltaY = lastTouchY - currentY;
            if (shouldLockScroll(messageList, deltaY)) {
              event.preventDefault();
            }
            lastTouchY = currentY;
          };

          const resetTouch = () => {
            lastTouchY = null;
          };

          messageList.addEventListener('touchmove', handleTouchMove, { passive: false });
          messageList.addEventListener('touchend', resetTouch);
          messageList.addEventListener('touchcancel', resetTouch);
        }
      })();
    </script>
    <script>
      (() => {
        const loader = document.getElementById('app-loader');
        if (loader) {
          const hideLoader = () => {
            requestAnimationFrame(() => {
              loader.dataset.hidden = 'true';
              setTimeout(() => {
                loader.remove();
              }, 600);
            });
          };

          window.addEventListener('load', hideLoader, { once: true });
          setTimeout(hideLoader, 2500);
        }
      })();
    </script>

    <script>
      // Initialize theme toggle button
      (() => {
        const container = document.getElementById('theme-toggle-container');
        if (container && window.ThemeManager) {
          window.ThemeManager.createToggleButton(container, {
            showLabel: false,
            showDropdown: true
          });
        }
      })();
    </script>

    <script>
      (() => {
        const sessionKey = 'ctechSession';
        const displayNameKey = 'ctechDisplayName';

        const indicator = document.querySelector('[data-user-indicator]');
        if (!indicator) {
          return;
        }

        function escapeHtml(value) {
          return String(value)
            .replaceAll('&', '&amp;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;')
            .replaceAll('"', '&quot;')
            .replaceAll("'", '&#39;');
        }

        function normalizeNamePart(value) {
          if (!value) {
            return '';
          }
          const lower = value.toLocaleLowerCase('vi-VN');
          return lower.charAt(0).toLocaleUpperCase('vi-VN') + lower.slice(1);
        }

        function extractGivenName(value) {
          if (!value) {
            return '';
          }
          const trimmed = value.trim();
          if (!trimmed) {
            return '';
          }
          const parts = trimmed.split(/\s+/);
          const given = parts[parts.length - 1];
          return normalizeNamePart(given);
        }

        function isLikelyIdentifier(value) {
          if (!value) {
            return true;
          }
          const sample = String(value).trim();
          if (!sample) {
            return true;
          }
          if (/[0-9]/.test(sample)) {
            return true;
          }
          if (!/\s/.test(sample) && sample === sample.toUpperCase()) {
            return true;
          }
          return false;
        }



        function loadSession() {
          try {
            return JSON.parse(localStorage.getItem(sessionKey) || 'null');
          } catch (error) {
            console.warn('Không thể đọc session:', error);
            return null;
          }
        }

        function saveSession(payload) {
          if (!payload) {
            return;
          }
          try {
            localStorage.setItem(sessionKey, JSON.stringify(payload));
          } catch (error) {
            console.warn('Không thể lưu session vào localStorage:', error);
          }
        }

        function saveDisplayName(value) {
          if (value && !isLikelyIdentifier(value)) {
            try {
              localStorage.setItem(displayNameKey, value);
            } catch (error) {
              console.warn('Không thể lưu displayName:', error);
            }
          } else {
            localStorage.removeItem(displayNameKey);
          }
        }

        function clearStoredSession() {
          localStorage.removeItem(sessionKey);
          localStorage.removeItem(displayNameKey);
        }

        function deriveStoredDisplayName(session) {
          const stored = localStorage.getItem(displayNameKey) || '';
          if (stored && !isLikelyIdentifier(stored)) {
            return stored;
          }

          if (session && session.user) {
            const candidate =
              session.user.displayName ||
              session.user.fullName ||
              session.user.name ||
              session.user.userId ||
              '';

            if (candidate && !isLikelyIdentifier(candidate)) {
              return candidate;
            }
          }

          return '';
        }

        function resolveIndicatorContext(session) {
          const safeStoredName = deriveStoredDisplayName(session);
          const rawUserId = session && session.user && session.user.userId;
          const displayUserId = isLikelyIdentifier(rawUserId) ? '' : String(rawUserId || '');
          const greetingName =
            extractGivenName(safeStoredName) ||
            extractGivenName(displayUserId) ||
            normalizeNamePart(displayUserId) ||
            'bạn';

          return {
            safeStoredName,
            displayUserId,
            greetingName,
          };
        }

        function renderIndicator(session) {
          if (session && session.token) {
            const { safeStoredName, displayUserId, greetingName } = resolveIndicatorContext(session);
            if (safeStoredName) {
              saveDisplayName(safeStoredName);
            } else if (displayUserId) {
              saveDisplayName(displayUserId);
            } else {
              saveDisplayName('');
            }

            indicator.innerHTML = `
              <span class="user-pill">Xin chào, <strong>${escapeHtml(greetingName)}</strong></span>
              <button type="button" class="user-logout" data-logout>Đăng xuất</button>
            `;

            const logoutBtn = indicator.querySelector('[data-logout]');
            if (logoutBtn) {
              logoutBtn.addEventListener('click', () => {
                clearStoredSession();
                window.location.href = '/login';
              });
            }
          } else {
            indicator.innerHTML = '<a class="user-link" href="/login">Đăng nhập</a>';
          }
        }

        async function fetchSessionFromToken(session) {
          if (!session || !session.token) {
            return null;
          }

          try {
            const response = await fetch('/api/auth/me', {
              headers: {
                Authorization: `Bearer ${session.token}`,
              },
            });

            if (response.status === 401 || response.status === 403) {
              clearStoredSession();
              if (window.location.pathname !== '/login') {
                window.location.href = '/login';
              }
              return null;
            }

            if (!response.ok) {
              throw new Error(`Unexpected status ${response.status}`);
            }

            const payload = await response.json();
            saveSession(payload);

            if (payload && payload.user) {
              const candidate =
                payload.user.displayName ||
                payload.user.fullName ||
                payload.user.name ||
                payload.user.userId;
              saveDisplayName(candidate || '');
            }

            return payload;
          } catch (error) {
            console.warn('Không thể đồng bộ thông tin người dùng:', error);
            return null;
          }
        }

        async function initIndicator() {
          const session = loadSession();
          renderIndicator(session);

          if (session && session.token) {
            const refreshed = await fetchSessionFromToken(session);
            if (refreshed) {
              renderIndicator(refreshed);
            } else {
              renderIndicator(loadSession());
            }
          }
        }

        initIndicator();
      })();
    </script>

    <script>
      // Back to top button
      (() => {
        const backToTopBtn = document.querySelector('[data-back-to-top]');
        if (!backToTopBtn) return;

        const toggleVisibility = () => {
          if (window.scrollY > 400) {
            backToTopBtn.hidden = false;
            backToTopBtn.classList.add('visible');
          } else {
            backToTopBtn.classList.remove('visible');
            setTimeout(() => {
              if (!backToTopBtn.classList.contains('visible')) {
                backToTopBtn.hidden = true;
              }
            }, 300);
          }
        };

        window.addEventListener('scroll', toggleVisibility, { passive: true });
        toggleVisibility();

        backToTopBtn.addEventListener('click', () => {
          window.scrollTo({
            top: 0,
            behavior: 'smooth'
          });
        });
      })();

    </script>
  </body>
</html>






























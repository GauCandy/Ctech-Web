<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lịch trình | CTECH</title>
    <link rel="icon" type="image/webp" href="/img/logo.webp" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/css/main.css" />
    <link rel="stylesheet" href="/css/schedule.css" />
    <link rel="stylesheet" href="/css/loader.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <script src="/js/themeManager.js"></script>
    <script src="/js/headerManager.js"></script>
  </head>
  <body>
    <div id="app-loader" class="loader-backdrop" aria-hidden="true">
      <div class="loader-logo">
        <img src="/img/logo.webp" alt="Logo CTECH" />
      </div>
    </div>

    <header class="site-header">
      <div class="header-inner container">
        <a class="brand" href="/" aria-label="Trang chủ CTECH">
          <img src="/img/logo.webp" alt="Logo CTECH" />
        </a>
        <div class="header-actions">
          <nav class="nav-links" aria-label="Điều hướng chính">
            <a href="/">Trang chủ</a>
            <a href="/#tai-sao-chon-ctech">Giới thiệu</a>
            <a href="/#chuong-trinh">Chương trình</a>
            <a href="/#doi-song">Đời sống</a>
            <a href="/services">Dịch vụ</a>
            <a href="/schedule" class="active">Lịch trình</a>
            <a href="/#tin-tuc">Tin tức</a>
          </nav>
          <div id="theme-toggle-container"></div>
          <div class="user-indicator" data-user-indicator>
            <a class="user-link" href="/login">Đăng nhập</a>
          </div>
        </div>
      </div>
    </header>

    <main class="site-main schedule-page">
      <section class="section">
        <div class="section-inner container">
          <div class="section-heading">
            <h1 class="section-title">Thời khóa biểu</h1>
            <p class="section-subtitle">
              Tải lên file PDF thời khóa biểu của bạn để xem lịch học chi tiết theo tuần
            </p>
          </div>

          <div class="upload-section">
            <div class="upload-card">
              <div class="upload-icon">
                <span class="material-icons">cloud_upload</span>
              </div>
              <h3>Tải lên thời khóa biểu</h3>
              <p>Chọn file PDF thời khóa biểu từ thiết bị của bạn</p>
              <form id="upload-form" enctype="multipart/form-data">
                <input
                  type="file"
                  id="pdf-file"
                  name="file"
                  accept=".pdf"
                  required
                  hidden
                />
                <label for="pdf-file" class="btn-upload">
                  <span class="material-icons">attach_file</span>
                  Chọn file PDF
                </label>
                <div id="file-info" class="file-info" hidden>
                  <span class="material-icons">description</span>
                  <span id="file-name"></span>
                  <button type="button" id="clear-file" class="btn-clear">
                    <span class="material-icons">close</span>
                  </button>
                </div>
                <button type="submit" class="btn-primary" id="upload-btn" disabled>
                  <span class="material-icons">upload</span>
                  Tải lên và xem lịch
                </button>
              </form>
              <div id="upload-status" class="upload-status"></div>
            </div>
          </div>

          <div id="schedule-container" class="schedule-container" hidden>
            <div class="schedule-header">
              <div class="schedule-header-left">
                <h2 id="schedule-class-name">Thời khóa biểu</h2>
                <div id="schedule-stats" class="schedule-stats" hidden>
                  <div class="stat-item">
                    <span class="material-icons">event</span>
                    <span id="total-classes">0</span> lớp
                  </div>
                  <div class="stat-item">
                    <span class="material-icons">schedule</span>
                    <span id="total-periods">0</span> tiết
                  </div>
                </div>
              </div>
              <div class="schedule-controls">
                <select id="week-select" class="week-select">
                  <option value="">Chọn tuần...</option>
                </select>
              </div>
            </div>

            <div id="schedule-view" class="schedule-view">
              <div class="schedule-empty">
                <span class="material-icons">event_busy</span>
                <p>Chọn tuần để xem thời khóa biểu</p>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer class="site-footer">
      <div class="footer-inner container">
        <div class="footer-columns">
          <div>
            <h4>Trụ sở chính</h4>
            <p>60 Quốc lộ 1A, xã Tân Phước Khánh, thành phố Hà Nội</p>
          </div>
          <div>
            <h4>Liên hệ</h4>
            <p>
              Tổng đài: <a href="tel:18006770">1800 6770</a><br />
              Email: <a href="mailto:contact@ctech.edu.vn">contact@ctech.edu.vn</a>
            </p>
          </div>
        </div>
      </div>
    </footer>

    <button class="back-to-top" type="button" data-back-to-top aria-label="Về đầu trang" hidden>
      <span class="material-icons" aria-hidden="true">arrow_upward</span>
    </button>

    <script>
      (() => {
        const loader = document.getElementById('app-loader');
        if (loader) {
          const hideLoader = () => {
            requestAnimationFrame(() => {
              loader.dataset.hidden = 'true';
              setTimeout(() => {
                loader.remove();
              }, 600);
            });
          };
          window.addEventListener('load', hideLoader, { once: true });
          setTimeout(hideLoader, 2500);
        }
      })();
    </script>

    <script>
      (() => {
        const container = document.getElementById('theme-toggle-container');
        if (container && window.ThemeManager) {
          window.ThemeManager.createToggleButton(container, {
            showLabel: false,
            showDropdown: true
          });
        }
      })();
    </script>

    <script>
      // Back to top button
      (() => {
        const backToTopBtn = document.querySelector('[data-back-to-top]');
        if (!backToTopBtn) return;

        const toggleVisibility = () => {
          if (window.scrollY > 400) {
            backToTopBtn.hidden = false;
            backToTopBtn.classList.add('visible');
          } else {
            backToTopBtn.classList.remove('visible');
            setTimeout(() => {
              if (!backToTopBtn.classList.contains('visible')) {
                backToTopBtn.hidden = true;
              }
            }, 300);
          }
        };

        window.addEventListener('scroll', toggleVisibility, { passive: true });
        toggleVisibility();

        backToTopBtn.addEventListener('click', () => {
          window.scrollTo({
            top: 0,
            behavior: 'smooth'
          });
        });
      })();
    </script>

    <script>
      // Schedule page logic
      (() => {
        const uploadForm = document.getElementById('upload-form');
        const pdfFileInput = document.getElementById('pdf-file');
        const fileInfo = document.getElementById('file-info');
        const fileName = document.getElementById('file-name');
        const clearFileBtn = document.getElementById('clear-file');
        const uploadBtn = document.getElementById('upload-btn');
        const uploadStatus = document.getElementById('upload-status');
        const scheduleContainer = document.getElementById('schedule-container');
        const weekSelect = document.getElementById('week-select');
        const scheduleView = document.getElementById('schedule-view');
        const scheduleClassName = document.getElementById('schedule-class-name');
        const scheduleStats = document.getElementById('schedule-stats');
        const totalClasses = document.getElementById('total-classes');
        const totalPeriods = document.getElementById('total-periods');

        let scheduleData = null;
        let selectedClassName = null;

        const daysMap = {
          'Thu 2': 'Thứ 2',
          'Thu 3': 'Thứ 3',
          'Thu 4': 'Thứ 4',
          'Thu 5': 'Thứ 5',
          'Thu 6': 'Thứ 6',
          'Thu 7': 'Thứ 7',
          'CN': 'Chủ nhật'
        };

        const daysOrder = ['Thu 2', 'Thu 3', 'Thu 4', 'Thu 5', 'Thu 6', 'Thu 7', 'CN'];
        const sessionsOrder = ['Sáng', 'Chiều', 'Tối'];

        // File input change handler
        pdfFileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
            fileName.textContent = file.name;
            fileInfo.hidden = false;
            uploadBtn.disabled = false;
          }
        });

        // Clear file button
        clearFileBtn.addEventListener('click', () => {
          pdfFileInput.value = '';
          fileInfo.hidden = true;
          uploadBtn.disabled = true;
        });

        // Upload form submit
        uploadForm.addEventListener('submit', async (e) => {
          e.preventDefault();

          const file = pdfFileInput.files[0];
          if (!file) return;

          const formData = new FormData();
          formData.append('file', file);

          uploadBtn.disabled = true;
          uploadStatus.innerHTML = '<div class="status-loading"><span class="material-icons spinning">sync</span> Đang xử lý file...</div>';

          try {
            const response = await fetch('/api/timetable/parse', {
              method: 'POST',
              body: formData
            });

            if (!response.ok) {
              throw new Error('Upload failed');
            }

            scheduleData = await response.json();
            uploadStatus.innerHTML = '<div class="status-success"><span class="material-icons">check_circle</span> Tải lên thành công!</div>';

            // Populate dropdowns
            populateDropdowns();
            scheduleContainer.hidden = false;

          } catch (error) {
            console.error('Upload error:', error);
            uploadStatus.innerHTML = '<div class="status-error"><span class="material-icons">error</span> Có lỗi xảy ra. Vui lòng thử lại.</div>';
            uploadBtn.disabled = false;
          }
        });

        function populateDropdowns() {
          if (!scheduleData || !scheduleData.sheets) return;

          // Get first class (assuming 1 PDF = 1 class)
          const firstSheet = Object.values(scheduleData.sheets)[0];
          if (!firstSheet) return;

          const classes = Object.keys(firstSheet);
          if (classes.length > 0) {
            selectedClassName = classes[0];
            scheduleClassName.textContent = `Thời khóa biểu - ${selectedClassName}`;
          }

          // Get week range
          let minWeek = Infinity;
          let maxWeek = -Infinity;

          Object.values(scheduleData.sheets).forEach(sheet => {
            Object.values(sheet).forEach(classList => {
              classList.forEach(subject => {
                if (subject.weekStart < minWeek) minWeek = subject.weekStart;
                if (subject.weekEnd > maxWeek) maxWeek = subject.weekEnd;
              });
            });
          });

          // Populate week select
          weekSelect.innerHTML = '<option value="">Chọn tuần...</option>';
          for (let week = minWeek; week <= maxWeek; week++) {
            const option = document.createElement('option');
            option.value = week;
            option.textContent = `Tuần ${week}`;
            weekSelect.appendChild(option);
          }
        }

        function calculatePeriods(subject, selectedWeek) {
          // Tính số tiết cho môn học trong tuần cụ thể
          if (subject.weekPeriods) {
            const weekPeriod = subject.weekPeriods.find(wp => wp.week === selectedWeek);
            if (weekPeriod) {
              return weekPeriod.periods || 5;
            }
          }
          return 5; // Mặc định 5 tiết/buổi
        }

        function updateStats(weekSubjects, selectedWeek) {
          if (!scheduleStats || !totalClasses || !totalPeriods) return;

          const uniqueSubjects = new Set();
          let totalPeriodsCount = 0;

          weekSubjects.forEach(subject => {
            uniqueSubjects.add(subject.subjectCode);
            totalPeriodsCount += calculatePeriods(subject, selectedWeek);
          });

          totalClasses.textContent = uniqueSubjects.size;
          totalPeriods.textContent = totalPeriodsCount;
          scheduleStats.hidden = false;
        }

        function renderSchedule() {
          const selectedWeek = parseInt(weekSelect.value);

          if (!selectedWeek || !selectedClassName || !scheduleData) {
            scheduleView.innerHTML = `
              <div class="schedule-empty">
                <span class="material-icons">event_busy</span>
                <p>Chọn tuần để xem thời khóa biểu</p>
              </div>
            `;
            if (scheduleStats) scheduleStats.hidden = true;
            return;
          }

          // Find class data
          let classSchedule = null;
          for (const sheet of Object.values(scheduleData.sheets)) {
            if (sheet[selectedClassName]) {
              classSchedule = sheet[selectedClassName];
              break;
            }
          }

          if (!classSchedule) {
            scheduleView.innerHTML = `
              <div class="schedule-empty">
                <span class="material-icons">error_outline</span>
                <p>Không tìm thấy lịch học cho lớp này</p>
              </div>
            `;
            return;
          }

          // Filter subjects for selected week
          const weekSubjects = classSchedule.filter(subject => {
            const inRange = selectedWeek >= subject.weekStart && selectedWeek <= subject.weekEnd;
            const notOff = !subject.weeksOff || !subject.weeksOff.includes(selectedWeek);
            return inRange && notOff;
          });

          if (weekSubjects.length === 0) {
            scheduleView.innerHTML = `
              <div class="schedule-empty">
                <span class="material-icons">event_available</span>
                <p>Không có lịch học trong tuần này</p>
              </div>
            `;
            if (scheduleStats) scheduleStats.hidden = true;
            return;
          }

          // Update statistics
          updateStats(weekSubjects, selectedWeek);

          // Group by day and session
          const scheduleGrid = {};
          daysOrder.forEach(day => {
            scheduleGrid[day] = {};
            sessionsOrder.forEach(session => {
              scheduleGrid[day][session] = [];
            });
          });

          weekSubjects.forEach(subject => {
            const day = subject.day || 'Thu 2';
            const session = subject.session || 'Sáng';
            if (scheduleGrid[day] && scheduleGrid[day][session]) {
              scheduleGrid[day][session].push(subject);
            }
          });

          // Render schedule table (horizontal layout)
          let html = '<div class="schedule-table-horizontal">';

          // Header row with days
          html += '<div class="schedule-row schedule-header-row">';
          html += '<div class="schedule-cell schedule-cell-header schedule-cell-session">Buổi</div>';
          daysOrder.forEach(day => {
            html += `<div class="schedule-cell schedule-cell-header">${daysMap[day] || day}</div>`;
          });
          html += '</div>';

          // Rows for each session
          sessionsOrder.forEach(session => {
            html += '<div class="schedule-row">';
            html += `<div class="schedule-cell schedule-cell-session"><strong>${session}</strong></div>`;

            daysOrder.forEach(day => {
              const subjects = scheduleGrid[day][session];
              html += '<div class="schedule-cell">';

              if (subjects.length > 0) {
                subjects.forEach(subject => {
                  const room = subject.room ||
                    (subject.roomAssignments && subject.roomAssignments.find(r =>
                      selectedWeek >= r.weekStart && selectedWeek <= r.weekEnd
                    )?.room) || 'Chưa xác định';

                  html += `
                    <div class="subject-block">
                      <div class="subject-block-header">
                        <span class="subject-code-small">${subject.subjectCode || ''}</span>
                      </div>
                      <div class="subject-name-small">${subject.subjectName || 'Không rõ'}</div>
                      <div class="subject-info-small">
                        <div><span class="material-icons icon-tiny">person</span>${subject.teacher || 'N/A'}</div>
                        <div><span class="material-icons icon-tiny">room</span>${room}</div>
                      </div>
                    </div>
                  `;
                });
              }

              html += '</div>';
            });

            html += '</div>';
          });

          html += '</div>';
          scheduleView.innerHTML = html;
        }

        weekSelect.addEventListener('change', renderSchedule);
      })();
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lịch trình | CTECH</title>
    <link rel="icon" type="image/webp" href="/img/logo.webp" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/css/main.css" />
    <link rel="stylesheet" href="/css/schedule.css" />
    <link rel="stylesheet" href="/css/loader.css" />
    <link rel="stylesheet" href="/css/user-menu.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <script src="/js/themeManager.js"></script>
    <script src="/js/remoteGestures.js"></script>
    <script src="/js/headerManager.js"></script>
    <script src="/js/swRegister.js"></script>
  </head>
  <body>
    <div id="app-loader" class="loader-backdrop" aria-hidden="true">
      <div class="loader-logo">
        <img src="/img/logo.webp" alt="Logo CTECH" />
      </div>
    </div>

    <header class="site-header">
      <div class="header-inner container">
        <a class="brand" href="/" aria-label="Trang chủ CTECH">
          <img src="/img/logo.webp" alt="Logo CTECH" />
        </a>
        <div class="header-actions">
          <nav class="nav-links" aria-label="Điều hướng chính">
            <a href="/">Trang chủ</a>
            <a href="/#tai-sao-chon-ctech">Giới thiệu</a>
            <a href="/#chuong-trinh">Chương trình</a>
            <a href="/#doi-song">Đời sống</a>
            <a href="/services">Dịch vụ</a>
            <a href="/schedule" class="active">Lịch trình</a>
          </nav>
          <div id="theme-toggle-container"></div>
          <div class="user-indicator" data-user-indicator>
            <a class="user-link" href="/login">Đăng nhập</a>
          </div>
        </div>
      </div>
    </header>

    <main class="site-main schedule-page">
      <section class="section">
        <div class="section-inner container">
          <div class="section-heading">
            <h1 class="section-title">Thời khóa biểu</h1>
            <p class="section-subtitle">
              Tải lên file PDF thời khóa biểu của bạn để xem lịch học chi tiết theo tuần
            </p>
            <div id="offline-indicator" class="offline-indicator" hidden>
              <span class="material-icons">cloud_off</span>
              <span>Đang offline - Chỉ xem được TKB đã lưu</span>
            </div>
          </div>

          <!-- Bảng giờ học cố định -->
          <div class="time-table-section">
            <h3 class="time-table-title">Bảng giờ học</h3>
            <div class="time-table-wrapper">
              <table class="time-table">
                <thead>
                  <tr>
                    <th rowspan="2" class="time-table-header-main">Tiết</th>
                    <th colspan="2" class="time-table-header-session morning">Buổi sáng</th>
                    <th colspan="2" class="time-table-header-session afternoon">Buổi chiều</th>
                    <th colspan="2" class="time-table-header-session evening">Buổi tối</th>
                  </tr>
                  <tr>
                    <th class="time-table-subheader">Lý thuyết</th>
                    <th class="time-table-subheader">Thực hành/Tích hợp</th>
                    <th class="time-table-subheader">Lý thuyết</th>
                    <th class="time-table-subheader">Thực hành/Tích hợp</th>
                    <th class="time-table-subheader">Lý thuyết</th>
                    <th class="time-table-subheader">Thực hành/Tích hợp</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="time-table-period">1</td>
                    <td>7h00 - 7h45</td>
                    <td>7h00 - 8h00</td>
                    <td>12h25 - 13h10</td>
                    <td>12h25 - 13h25</td>
                    <td>18h00 - 18h45</td>
                    <td>18h00 - 19h00</td>
                  </tr>
                  <tr>
                    <td class="time-table-period">2</td>
                    <td>7h50 - 8h35</td>
                    <td>8h00 - 9h00</td>
                    <td>13h15 - 14h00</td>
                    <td>13h25 - 14h25</td>
                    <td>18h45 - 19h30</td>
                    <td>19h00 - 20h00</td>
                  </tr>
                  <tr>
                    <td class="time-table-period">3</td>
                    <td>8h45 - 9h30</td>
                    <td>9h10 - 10h10</td>
                    <td>14h10 - 14h55</td>
                    <td>14h35 - 15h35</td>
                    <td>19h30 - 20h15</td>
                    <td>20h00 - 21h00</td>
                  </tr>
                  <tr>
                    <td class="time-table-period">4</td>
                    <td>9h35 - 10h20</td>
                    <td>10h10 - 11h10</td>
                    <td>15h00 - 15h45</td>
                    <td>15h35 - 16h35</td>
                    <td colspan="2" class="time-table-empty"></td>
                  </tr>
                  <tr>
                    <td class="time-table-period">5</td>
                    <td>10h25 - 11h10</td>
                    <td>11h10 - 12h10</td>
                    <td>15h50 - 16h35</td>
                    <td>16h35 - 17h35</td>
                    <td colspan="2" class="time-table-empty"></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="upload-section">
            <div class="upload-card">
              <div class="upload-icon">
                <span class="material-icons">cloud_upload</span>
              </div>
              <h3>Tải lên thời khóa biểu</h3>
              <p>Chọn file PDF thời khóa biểu từ thiết bị của bạn</p>
              <form id="upload-form" enctype="multipart/form-data">
                <input
                  type="file"
                  id="pdf-file"
                  name="file"
                  accept=".pdf"
                  required
                  hidden
                />
                <label for="pdf-file" class="btn-upload">
                  <span class="material-icons">attach_file</span>
                  Chọn file PDF
                </label>
                <div id="file-info" class="file-info" hidden>
                  <span class="material-icons">description</span>
                  <span id="file-name"></span>
                  <button type="button" id="clear-file" class="btn-clear">
                    <span class="material-icons">close</span>
                  </button>
                </div>
                <button type="submit" class="btn-primary" id="upload-btn" disabled>
                  <span class="material-icons">upload</span>
                  Tải lên và xem lịch
                </button>
              </form>
              <div id="upload-status" class="upload-status"></div>
            </div>
          </div>

          <div id="schedule-container" class="schedule-container" hidden>
            <div class="schedule-header">
              <h2 id="schedule-class-name">Thời khóa biểu</h2>
              <div class="schedule-controls">
                <select id="saved-schedules-select" class="week-select" title="Xem TKB đã lưu">
                  <option value="">TKB đã lưu...</option>
                </select>
                <select id="week-select" class="week-select">
                  <option value="">Chọn tuần...</option>
                </select>
                <button type="button" id="share-schedule-btn" class="btn-icon" title="Chia sẻ TKB">
                  <span class="material-icons">share</span>
                </button>
              </div>
            </div>

            <p id="schedule-meta" class="schedule-meta" hidden></p>

            <div id="schedule-view" class="schedule-view">
              <div class="schedule-empty">
                <span class="material-icons">event_busy</span>
                <p>Chọn tuần để xem thời khóa biểu</p>
              </div>
            </div>

            <div class="schedule-actions">
              <button type="button" id="upload-another-btn" class="btn-upload-another">
                <span class="material-icons">upload_file</span>
                Tải lên thời khóa biểu khác
              </button>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer class="site-footer">
      <div class="footer-inner container">
        <div class="footer-columns">
          <div>
            <h4>Trụ Sở Chính</h4>
            <p>60 QL1A, xã Thượng Tín, thành phố Hà Nội</p>
          </div>
          <div>
            <h4>Cơ sở đào tạo</h4>
            <p>số 57 đường Cách Mạng Tháng Tám, phường Bình Thủy, TP. Cần Thơ</p>
          </div>
          <div>
            <h4>Liên hệ</h4>
            <p>
              Tổng đài: <a href="tel:18006770">1800 6770</a><br />
              Email: <a href="mailto:contact@ctech.edu.vn">contact@ctech.edu.vn</a>
            </p>
          </div>
        </div>
      </div>
    </footer>

    <button class="back-to-top" type="button" data-back-to-top aria-label="Về đầu trang" hidden>
      <span class="material-icons" aria-hidden="true">arrow_upward</span>
    </button>

    <script>
      (() => {
        const loader = document.getElementById('app-loader');
        if (loader) {
          const hideLoader = () => {
            requestAnimationFrame(() => {
              loader.dataset.hidden = 'true';
              setTimeout(() => {
                loader.remove();
              }, 600);
            });
          };
          window.addEventListener('load', hideLoader, { once: true });
          setTimeout(hideLoader, 2500);
        }
      })();
    </script>

    <script>
      (() => {
        const container = document.getElementById('theme-toggle-container');
        if (container && window.ThemeManager) {
          window.ThemeManager.createToggleButton(container, {
            showLabel: false,
            showDropdown: true
          });
        }
      })();
    </script>

    <script>
      // Back to top button
      (() => {
        const backToTopBtn = document.querySelector('[data-back-to-top]');
        if (!backToTopBtn) return;

        const toggleVisibility = () => {
          if (window.scrollY > 400) {
            backToTopBtn.hidden = false;
            backToTopBtn.classList.add('visible');
          } else {
            backToTopBtn.classList.remove('visible');
            setTimeout(() => {
              if (!backToTopBtn.classList.contains('visible')) {
                backToTopBtn.hidden = true;
              }
            }, 300);
          }
        };

        window.addEventListener('scroll', toggleVisibility, { passive: true });
        toggleVisibility();

        backToTopBtn.addEventListener('click', () => {
          window.scrollTo({
            top: 0,
            behavior: 'smooth'
          });
        });
      })();
    </script>

    <script>
      // Schedule page logic
      (() => {
        const uploadForm = document.getElementById('upload-form');
        const pdfFileInput = document.getElementById('pdf-file');
        const fileInfo = document.getElementById('file-info');
        const fileName = document.getElementById('file-name');
        const clearFileBtn = document.getElementById('clear-file');
        const uploadBtn = document.getElementById('upload-btn');
        const uploadStatus = document.getElementById('upload-status');
        const uploadSection = document.querySelector('.upload-section');
        const scheduleContainer = document.getElementById('schedule-container');
        const uploadAnotherBtn = document.getElementById('upload-another-btn');
        const weekSelect = document.getElementById('week-select');
        const scheduleView = document.getElementById('schedule-view');
        const scheduleMeta = document.getElementById('schedule-meta');
        const scheduleClassName = document.getElementById('schedule-class-name');
        const savedSchedulesSelect = document.getElementById('saved-schedules-select');
        const shareScheduleBtn = document.getElementById('share-schedule-btn');

        let scheduleData = null;
        let selectedClassName = null;
        let currentScheduleId = null;

        const STORAGE_KEY = 'saved_schedules';
        const offlineIndicator = document.getElementById('offline-indicator');
        let isOnline = true;

        // Check real internet connectivity by pinging server
        async function checkInternetConnection() {
          try {
            // Try to fetch from our own API first (faster)
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 3000); // 3s timeout

            const response = await fetch('/api/status', {
              method: 'HEAD',
              cache: 'no-cache',
              signal: controller.signal
            });

            clearTimeout(timeoutId);
            return response.ok;
          } catch (error) {
            // If our API fails, try Google as fallback
            try {
              const controller = new AbortController();
              const timeoutId = setTimeout(() => controller.abort(), 3000);

              await fetch('https://www.google.com/favicon.ico', {
                method: 'HEAD',
                mode: 'no-cors',
                cache: 'no-cache',
                signal: controller.signal
              });

              clearTimeout(timeoutId);
              return true;
            } catch (err) {
              return false;
            }
          }
        }

        // Update online status with real check
        async function updateOnlineStatus() {
          const online = await checkInternetConnection();
          isOnline = online;

          if (!online) {
            offlineIndicator.hidden = false;
            // Disable share button when offline
            if (shareScheduleBtn) {
              shareScheduleBtn.disabled = true;
              shareScheduleBtn.title = 'Không thể chia sẻ khi offline';
            }
          } else {
            offlineIndicator.hidden = true;
            // Re-enable share button when online
            if (shareScheduleBtn && scheduleData) {
              shareScheduleBtn.disabled = false;
              shareScheduleBtn.title = 'Chia sẻ TKB';
            }
          }

          return online;
        }

        // Check periodically (every 30 seconds when page is visible)
        let statusCheckInterval;
        function startStatusCheck() {
          updateOnlineStatus(); // Check immediately
          statusCheckInterval = setInterval(updateOnlineStatus, 30000);
        }

        function stopStatusCheck() {
          if (statusCheckInterval) {
            clearInterval(statusCheckInterval);
          }
        }

        // Only check when page is visible to save battery/resources
        document.addEventListener('visibilitychange', () => {
          if (document.hidden) {
            stopStatusCheck();
          } else {
            startStatusCheck();
          }
        });

        // Also listen to browser online/offline events as hint
        window.addEventListener('online', () => {
          updateOnlineStatus();
        });

        window.addEventListener('offline', () => {
          updateOnlineStatus();
        });

        // LocalStorage functions
        function getSavedSchedules() {
          try {
            const saved = localStorage.getItem(STORAGE_KEY);
            return saved ? JSON.parse(saved) : [];
          } catch (error) {
            console.error('Error loading saved schedules:', error);
            return [];
          }
        }

        function saveSchedule(scheduleData, fileName) {
          try {
            const schedules = getSavedSchedules();
            const id = Date.now().toString();
            const newSchedule = {
              id,
              fileName: fileName || 'Thời khóa biểu',
              uploadedAt: new Date().toISOString(),
              data: scheduleData
            };

            // Thêm schedule mới vào đầu danh sách
            schedules.unshift(newSchedule);

            // Giới hạn chỉ lưu 10 TKB gần nhất
            if (schedules.length > 10) {
              schedules.splice(10);
            }

            localStorage.setItem(STORAGE_KEY, JSON.stringify(schedules));
            return id;
          } catch (error) {
            console.error('Error saving schedule:', error);
            return null;
          }
        }

        function loadScheduleById(id) {
          const schedules = getSavedSchedules();
          return schedules.find(s => s.id === id);
        }

        function deleteScheduleById(id) {
          try {
            const schedules = getSavedSchedules();
            const filtered = schedules.filter(s => s.id !== id);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(filtered));
          } catch (error) {
            console.error('Error deleting schedule:', error);
          }
        }

        function populateSavedSchedulesDropdown() {
          const schedules = getSavedSchedules();
          savedSchedulesSelect.innerHTML = '<option value="">TKB đã lưu...</option>';

          schedules.forEach(schedule => {
            const option = document.createElement('option');
            option.value = schedule.id;
            const date = new Date(schedule.uploadedAt);
            const dateStr = `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
            option.textContent = `${schedule.fileName} - ${dateStr}`;
            savedSchedulesSelect.appendChild(option);
          });
        }

        function loadMostRecentSchedule() {
          const schedules = getSavedSchedules();
          if (schedules.length > 0) {
            const mostRecent = schedules[0];
            loadScheduleFromSaved(mostRecent);
            return true;
          }
          return false;
        }

        function loadScheduleFromSaved(savedSchedule) {
          scheduleData = savedSchedule.data;
          currentScheduleId = savedSchedule.id;

          // Populate dropdowns
          populateDropdowns();
          populateSavedSchedulesDropdown();

          // Set selected value in dropdown
          savedSchedulesSelect.value = savedSchedule.id;

          // Hide upload section and show schedule
          uploadSection.style.display = 'none';
          scheduleContainer.hidden = false;
        }

        const daysMap = {
          'Thu 2': 'Thứ 2',
          'Thu 3': 'Thứ 3',
          'Thu 4': 'Thứ 4',
          'Thu 5': 'Thứ 5',
          'Thu 6': 'Thứ 6',
          'Thu 7': 'Thứ 7',
          'CN': 'Chủ nhật'
        };

        const daysOrder = ['Thu 2', 'Thu 3', 'Thu 4', 'Thu 5', 'Thu 6', 'Thu 7', 'CN'];
        const sessionsOrder = ['Sáng', 'Chiều', 'Tối'];

        // File input change handler - Auto upload when file selected
        pdfFileInput.addEventListener('change', async (e) => {
          const file = e.target.files[0];
          if (file) {
            fileName.textContent = file.name;
            fileInfo.hidden = false;

            // Auto submit form immediately
            await handleUpload(file);
          }
        });

        // Clear file button
        clearFileBtn.addEventListener('click', () => {
          pdfFileInput.value = '';
          fileInfo.hidden = true;
          uploadBtn.disabled = true;
        });

        // Handle upload function
        async function handleUpload(file) {
          if (!file) return;

          const formData = new FormData();
          formData.append('file', file);

          uploadBtn.disabled = true;
          uploadStatus.innerHTML = '<div class="status-loading"><span class="material-icons spinning">sync</span> Đang xử lý file...</div>';

          try {
            const response = await fetch('/api/timetable/parse', {
              method: 'POST',
              body: formData
            });

            if (!response.ok) {
              throw new Error('Upload failed');
            }

            scheduleData = await response.json();
            uploadStatus.innerHTML = '<div class="status-success"><span class="material-icons">check_circle</span> Tải lên thành công!</div>';

            // Save to localStorage
            const savedId = saveSchedule(scheduleData, file.name);
            currentScheduleId = savedId;

            // Populate dropdowns
            populateDropdowns();
            populateSavedSchedulesDropdown();
            if (savedId) {
              savedSchedulesSelect.value = savedId;
            }
            scheduleContainer.hidden = false;
            uploadBtn.disabled = false;

            // Hide upload section immediately after successful upload
            uploadSection.style.display = 'none';
            scheduleContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });

          } catch (error) {
            console.error('Upload error:', error);
            uploadStatus.innerHTML = '<div class="status-error"><span class="material-icons">error</span> Có lỗi xảy ra. Vui lòng thử lại.</div>';
            uploadBtn.disabled = false;
          }
        }

        // Upload form submit (for manual submission if needed)
        uploadForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const file = pdfFileInput.files[0];
          await handleUpload(file);
        });

        // Upload another schedule button
        uploadAnotherBtn.addEventListener('click', () => {
          // Reset form
          pdfFileInput.value = '';
          fileInfo.hidden = true;
          uploadBtn.disabled = true;
          uploadStatus.innerHTML = '';

          // Hide schedule container
          scheduleContainer.hidden = true;

          // Show upload section
          uploadSection.style.display = 'flex';

          // Scroll to upload section
          uploadSection.scrollIntoView({ behavior: 'smooth', block: 'center' });

          // Reset schedule data
          scheduleData = null;
          selectedClassName = null;
        });

        function populateDropdowns() {
          if (!scheduleData || !scheduleData.sheets) return;

          const metadata = scheduleData.metadata || null;

          // Get first class (assuming 1 PDF = 1 class)
          const firstSheet = Object.values(scheduleData.sheets)[0];
          if (!firstSheet) return;

          const classes = Object.keys(firstSheet);
          if (classes.length > 0) {
            selectedClassName = classes[0];
            scheduleClassName.textContent = `Thời khóa biểu - ${selectedClassName}`;
          }

          // Determine week range
          let minWeek = metadata?.weekRange?.start ?? Infinity;
          let maxWeek = metadata?.weekRange?.end ?? -Infinity;

          if (!Number.isFinite(minWeek) || !Number.isFinite(maxWeek)) {
            minWeek = Infinity;
            maxWeek = -Infinity;

            Object.values(scheduleData.sheets).forEach((sheet) => {
              Object.values(sheet).forEach((classList) => {
                classList.forEach((subject) => {
                  if (Number.isFinite(subject.weekStart) && subject.weekStart < minWeek) {
                    minWeek = subject.weekStart;
                  }
                  if (Number.isFinite(subject.weekEnd) && subject.weekEnd > maxWeek) {
                    maxWeek = subject.weekEnd;
                  }
                });
              });
            });
          }

          if (!Number.isFinite(minWeek) || minWeek === Infinity) {
            minWeek = 1;
          }
          if (!Number.isFinite(maxWeek) || maxWeek === -Infinity) {
            maxWeek = minWeek;
          }
          if (minWeek > maxWeek) {
            const temp = minWeek;
            minWeek = maxWeek;
            maxWeek = temp;
          }

          // Populate week select
          weekSelect.innerHTML = '<option value="">Chọn tuần...</option>';
          for (let week = minWeek; week <= maxWeek; week += 1) {
            const option = document.createElement('option');
            option.value = week;
            option.textContent = `Tuần ${String(week).padStart(2, '0')}`;
            weekSelect.appendChild(option);
          }

          const defaultWeek = determineDefaultWeek(metadata, minWeek, maxWeek);
          if (Number.isFinite(defaultWeek) && weekSelect.querySelector(`option[value="${defaultWeek}"]`)) {
            weekSelect.value = String(defaultWeek);
          } else {
            weekSelect.value = '';
          }

          const selectedWeekNumber = Number.parseInt(weekSelect.value, 10);
          updateMetadataDisplay(Number.isFinite(selectedWeekNumber) ? selectedWeekNumber : null);
          renderSchedule();
        }

        function getPeriodsForDay(subject, selectedWeek) {
          // Kiểm tra nếu tuần này có weekPeriods đặc biệt
          if (subject.weekPeriods) {
            const weekPeriod = subject.weekPeriods.find(wp => wp.week === selectedWeek);
            if (weekPeriod && weekPeriod.periods) {
              return weekPeriod.periods;
            }
          }
          // Mặc định 5 tiết/buổi
          return 5;
        }

        function formatIsoDateLabel(isoDate) {
          if (!isoDate || typeof isoDate !== 'string') {
            return null;
          }

          const parts = isoDate.split('-').map((part) => Number.parseInt(part, 10));
          if (parts.length !== 3) {
            return null;
          }

          const [year, month, day] = parts;
          if (!Number.isFinite(year) || !Number.isFinite(month) || !Number.isFinite(day)) {
            return null;
          }

          const paddedDay = String(day).padStart(2, '0');
          const paddedMonth = String(month).padStart(2, '0');
          return `${paddedDay}/${paddedMonth}/${year}`;
        }

        function clampWeek(value, minWeek, maxWeek) {
          if (!Number.isFinite(value)) {
            return null;
          }

          let result = value;
          if (Number.isFinite(minWeek) && result < minWeek) {
            result = minWeek;
          }
          if (Number.isFinite(maxWeek) && result > maxWeek) {
            result = maxWeek;
          }
          return result;
        }

        function determineDefaultWeek(metadata, minWeek, maxWeek) {
          if (metadata) {
            const { currentWeek, currentWeekStatus, weekRange } = metadata;

            if (Number.isFinite(currentWeek)) {
              if (currentWeekStatus === 'before-range' && weekRange) {
                return clampWeek(weekRange.start, minWeek, maxWeek);
              }
              if (currentWeekStatus === 'after-range' && weekRange) {
                return clampWeek(weekRange.end, minWeek, maxWeek);
              }
              return clampWeek(currentWeek, minWeek, maxWeek);
            }

            if (weekRange && Number.isFinite(weekRange.start)) {
              return clampWeek(weekRange.start, minWeek, maxWeek);
            }
          }

          if (Number.isFinite(minWeek)) {
            return minWeek;
          }

          return null;
        }

        function updateMetadataDisplay(selectedWeek) {
          if (!scheduleMeta) return;

          const metadata = scheduleData?.metadata;
          if (!metadata) {
            scheduleMeta.hidden = true;
            scheduleMeta.textContent = '';
            return;
          }

          const chips = [];

          if (metadata.faculty) {
            chips.push(`Khoa: ${metadata.faculty}`);
          }

          if (metadata.weekRange && Number.isFinite(metadata.weekRange.start) && Number.isFinite(metadata.weekRange.end)) {
            chips.push(`Tuần ${metadata.weekRange.start} – ${metadata.weekRange.end}`);
          }

          if (metadata.dateRange?.startDate && metadata.dateRange?.endDate) {
            const startLabel = formatIsoDateLabel(metadata.dateRange.startDate);
            const endLabel = formatIsoDateLabel(metadata.dateRange.endDate);
            if (startLabel && endLabel) {
              chips.push(`Từ ${startLabel} đến ${endLabel}`);
            }
          }

          if (Number.isFinite(metadata.currentWeek)) {
            let currentLabel = `Tuần hiện tại: ${metadata.currentWeek}`;
            const currentRange = metadata.currentWeekRange;

            if (currentRange?.startDate && currentRange?.endDate) {
              const rangeStart = formatIsoDateLabel(currentRange.startDate);
              const rangeEnd = formatIsoDateLabel(currentRange.endDate);
              if (rangeStart && rangeEnd) {
                currentLabel += ` (${rangeStart} - ${rangeEnd})`;
              }
            }

            if (metadata.currentWeekStatus === 'before-range') {
              currentLabel += ' (Chưa bắt đầu)';
            } else if (metadata.currentWeekStatus === 'after-range') {
              currentLabel += ' (Đã kết thúc)';
            }

            chips.push(currentLabel);
          } else if (metadata.today) {
            const todayLabel = formatIsoDateLabel(metadata.today);
            if (todayLabel) {
              chips.push(`Hôm nay: ${todayLabel}`);
            }
          }

          if (Number.isFinite(selectedWeek)) {
            const anchors = Array.isArray(metadata.weekDateAnchors) ? metadata.weekDateAnchors : [];
            const anchor = anchors.find((item) => item.week === selectedWeek);

            if (anchor) {
              const startLabel = formatIsoDateLabel(anchor.startDate);
              const endLabel = formatIsoDateLabel(anchor.endDate);
              if (startLabel && endLabel) {
                chips.push(`Đang xem: Tuần ${selectedWeek} (${startLabel} - ${endLabel})`);
              } else {
                chips.push(`Đang xem: Tuần ${selectedWeek}`);
              }
            } else {
              chips.push(`Đang xem: Tuần ${selectedWeek}`);
            }
          }

          if (chips.length === 0) {
            scheduleMeta.hidden = true;
            scheduleMeta.textContent = '';
            return;
          }

          scheduleMeta.innerHTML = '';
          chips.forEach((text) => {
            const chip = document.createElement('span');
            chip.textContent = text;
            scheduleMeta.appendChild(chip);
          });
          scheduleMeta.hidden = false;
        }

        function renderSchedule() {
          if (!scheduleData) {
            scheduleView.innerHTML = `
              <div class="schedule-empty">
                <span class="material-icons">event_busy</span>
                <p>Chọn tuần để xem thời khóa biểu</p>
              </div>
            `;
            updateMetadataDisplay(null);
            return;
          }

          const selectedWeek = Number.parseInt(weekSelect.value, 10);

          if (!Number.isFinite(selectedWeek) || !selectedClassName) {
            scheduleView.innerHTML = `
              <div class="schedule-empty">
                <span class="material-icons">event_busy</span>
                <p>Chọn tuần để xem thời khóa biểu</p>
              </div>
            `;
            updateMetadataDisplay(null);
            return;
          }

          updateMetadataDisplay(selectedWeek);

          // Find class data
          let classSchedule = null;
          for (const sheet of Object.values(scheduleData.sheets)) {
            if (sheet[selectedClassName]) {
              classSchedule = sheet[selectedClassName];
              break;
            }
          }

          if (!classSchedule) {
            scheduleView.innerHTML = `
              <div class="schedule-empty">
                <span class="material-icons">error_outline</span>
                <p>Không tìm thấy lịch học cho lớp này</p>
              </div>
            `;
            return;
          }

          // Filter subjects for selected week
          const weekSubjects = classSchedule.filter(subject => {
            const inRange = selectedWeek >= subject.weekStart && selectedWeek <= subject.weekEnd;
            const notOff = !subject.weeksOff || !subject.weeksOff.includes(selectedWeek);
            return inRange && notOff;
          });

          if (weekSubjects.length === 0) {
            scheduleView.innerHTML = `
              <div class="schedule-empty">
                <span class="material-icons">event_available</span>
                <p>Không có lịch học trong tuần này</p>
              </div>
            `;
            return;
          }

          // Group by day and session
          const scheduleGrid = {};
          daysOrder.forEach(day => {
            scheduleGrid[day] = {};
            sessionsOrder.forEach(session => {
              scheduleGrid[day][session] = [];
            });
          });

          weekSubjects.forEach(subject => {
            const day = subject.day || 'Thu 2';
            const session = subject.session || 'Sáng';
            if (scheduleGrid[day] && scheduleGrid[day][session]) {
              scheduleGrid[day][session].push(subject);
            }
          });

          // Render schedule table (horizontal layout)
          let html = '<div class="schedule-table-horizontal">';

          // Header row with days
          html += '<div class="schedule-row schedule-header-row">';
          html += '<div class="schedule-cell schedule-cell-header schedule-cell-session">Buổi</div>';
          daysOrder.forEach(day => {
            html += `<div class="schedule-cell schedule-cell-header">${daysMap[day] || day}</div>`;
          });
          html += '</div>';

          // Rows for each session
          sessionsOrder.forEach(session => {
            html += '<div class="schedule-row">';
            html += `<div class="schedule-cell schedule-cell-session"><strong>${session}</strong></div>`;

            daysOrder.forEach(day => {
              const subjects = scheduleGrid[day][session];
              html += '<div class="schedule-cell">';

              if (subjects.length > 0) {
                subjects.forEach(subject => {
                  const room = subject.room ||
                    (subject.roomAssignments && subject.roomAssignments.find(r =>
                      selectedWeek >= r.weekStart && selectedWeek <= r.weekEnd
                    )?.room) || 'Chưa xác định';

                  // Lấy số tiết của ngày hôm đó
                  const periodsToday = getPeriodsForDay(subject, selectedWeek);

                  // Tổng số tiết của môn học
                  const totalHours = subject.hours || 0;

                  html += `
                    <div class="subject-block">
                      <div class="subject-block-header">
                        <span class="subject-code-small">${subject.subjectCode || ''}</span>
                        <span class="subject-periods-badge">${periodsToday} tiết</span>
                      </div>
                      <div class="subject-name-small">${subject.subjectName || 'Không rõ'}</div>
                      <div class="subject-info-small">
                        <div><span class="material-icons icon-tiny">person</span>${subject.teacher || 'N/A'}</div>
                        <div><span class="material-icons icon-tiny">room</span>${room}</div>
                        <div><span class="material-icons icon-tiny">schedule</span>Tổng: ${totalHours} tiết</div>
                      </div>
                    </div>
                  `;
                });
              }

              html += '</div>';
            });

            html += '</div>';
          });

          html += '</div>';
          scheduleView.innerHTML = html;
        }

        weekSelect.addEventListener('change', renderSchedule);

        // Saved schedules dropdown change handler
        savedSchedulesSelect.addEventListener('change', (e) => {
          const selectedId = e.target.value;
          if (!selectedId) return;

          const savedSchedule = loadScheduleById(selectedId);
          if (savedSchedule) {
            loadScheduleFromSaved(savedSchedule);
          }
        });

        // Share button handler
        shareScheduleBtn.addEventListener('click', async () => {
          if (!scheduleData || !selectedClassName) {
            alert('Không có thời khóa biểu để chia sẻ');
            return;
          }

          try {
            // Show loading
            shareScheduleBtn.disabled = true;
            shareScheduleBtn.innerHTML = '<span class="material-icons spinning">sync</span>';

            // Upload to server
            const response = await fetch('/api/timetable/share', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                scheduleData: scheduleData,
                fileName: currentScheduleId ? loadScheduleById(currentScheduleId)?.fileName : 'Thời khóa biểu'
              })
            });

            if (!response.ok) {
              throw new Error('Failed to share schedule');
            }

            const result = await response.json();
            const selectedWeek = Number.parseInt(weekSelect.value, 10);
            const shareUrl = `${window.location.origin}${result.shareUrl}`;
            const shareText = `Thời khóa biểu - ${selectedClassName}${Number.isFinite(selectedWeek) ? ` (Tuần ${selectedWeek})` : ''}`;

            // Restore button
            shareScheduleBtn.disabled = false;
            shareScheduleBtn.innerHTML = '<span class="material-icons">share</span>';

            // Try Web Share API first
            if (navigator.share) {
              try {
                await navigator.share({
                  title: shareText,
                  text: shareText,
                  url: shareUrl
                });
              } catch (error) {
                if (error.name !== 'AbortError') {
                  console.error('Error sharing:', error);
                  fallbackShare(shareUrl, shareText);
                }
              }
            } else {
              fallbackShare(shareUrl, shareText);
            }
          } catch (error) {
            console.error('Error creating share link:', error);
            shareScheduleBtn.disabled = false;
            shareScheduleBtn.innerHTML = '<span class="material-icons">share</span>';
            alert('Không thể tạo link chia sẻ. Vui lòng thử lại.');
          }
        });

        function fallbackShare(url, text) {
          // Copy to clipboard
          const fullText = `${text}\n${url}`;

          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(fullText)
              .then(() => {
                alert('Đã sao chép link vào clipboard!');
              })
              .catch((error) => {
                console.error('Copy failed:', error);
                promptManualCopy(fullText);
              });
          } else {
            promptManualCopy(fullText);
          }
        }

        function promptManualCopy(text) {
          const textarea = document.createElement('textarea');
          textarea.value = text;
          textarea.style.position = 'fixed';
          textarea.style.opacity = '0';
          document.body.appendChild(textarea);
          textarea.select();

          try {
            document.execCommand('copy');
            alert('Đã sao chép link vào clipboard!');
          } catch (error) {
            console.error('Copy failed:', error);
            alert('Không thể sao chép. Link: ' + window.location.href);
          }

          document.body.removeChild(textarea);
        }

        // Load shared schedule from URL
        async function loadSharedScheduleFromUrl() {
          const urlParams = new URLSearchParams(window.location.search);
          const shareId = urlParams.get('share');

          if (!shareId) {
            return false;
          }

          // Check if offline
          if (!isOnline) {
            console.log('[Schedule] Offline - cannot load shared schedule from URL');
            uploadStatus.innerHTML = '<div class="status-error"><span class="material-icons">cloud_off</span> Không thể tải TKB được chia sẻ khi offline. Vui lòng kết nối internet và thử lại.</div>';
            uploadStatus.style.display = 'block';

            // Try to load most recent local schedule as fallback
            const hasLocalSchedule = loadMostRecentSchedule();
            if (hasLocalSchedule) {
              uploadStatus.innerHTML += '<div class="status-success" style="margin-top: 0.5rem;"><span class="material-icons">info</span> Đã tải TKB từ bộ nhớ local thay thế.</div>';
            }

            return hasLocalSchedule;
          }

          try {
            const response = await fetch(`/api/timetable/share/${shareId}`);

            if (!response.ok) {
              throw new Error('Failed to load shared schedule');
            }

            const result = await response.json();

            // Load the shared schedule
            scheduleData = result.scheduleData;
            currentScheduleId = null; // Not a local schedule

            // Save to localStorage for offline access
            const savedId = saveSchedule(result.scheduleData, result.fileName || 'Thời khóa biểu (Đã chia sẻ)');
            currentScheduleId = savedId;

            // Populate dropdowns
            populateDropdowns();
            populateSavedSchedulesDropdown();
            if (savedId) {
              savedSchedulesSelect.value = savedId;
            }

            // Hide upload section and show schedule
            uploadSection.style.display = 'none';
            scheduleContainer.hidden = false;

            // Show success message
            uploadStatus.innerHTML = '<div class="status-success"><span class="material-icons">cloud_done</span> Đã tải TKB được chia sẻ và lưu vào bộ nhớ để xem offline.</div>';
            uploadStatus.style.display = 'block';
            setTimeout(() => {
              uploadStatus.style.display = 'none';
            }, 5000);

            return true;
          } catch (error) {
            console.error('Error loading shared schedule:', error);
            uploadStatus.innerHTML = '<div class="status-error"><span class="material-icons">error</span> Không thể tải TKB được chia sẻ. Link có thể đã hết hạn hoặc không tồn tại.</div>';
            uploadStatus.style.display = 'block';
            return false;
          }
        }

        // Initialize: Load schedule on page load
        window.addEventListener('DOMContentLoaded', async () => {
          // Start periodic online status check
          startStatusCheck();

          // Wait for initial status check to complete
          await updateOnlineStatus();

          // First, try to load from share URL
          const loadedFromShare = await loadSharedScheduleFromUrl();

          if (!loadedFromShare) {
            // If no share URL, try to load most recent local schedule
            const hasSchedule = loadMostRecentSchedule();
            if (!hasSchedule) {
              // No saved schedules, show upload section
              if (isOnline) {
                uploadSection.style.display = 'flex';
              } else {
                // Offline and no local schedules - show message
                uploadSection.style.display = 'flex';
                uploadStatus.innerHTML = '<div class="status-error"><span class="material-icons">cloud_off</span> Bạn đang offline và chưa có TKB nào được lưu. Vui lòng kết nối internet để tải lên TKB.</div>';
                uploadStatus.style.display = 'block';
              }
              scheduleContainer.hidden = true;
            }
          }
        });
      })();
    </script>

    <script>
      // Presentation remote gesture support for schedule page
      (() => {
        let upTapCount = 0;
        let upTapTimer = null;
        let enterTapCount = 0;
        let enterTapTimer = null;
        const TAP_THRESHOLD = 500; // milliseconds

        document.addEventListener('keydown', (e) => {
          // Up arrow taps (2x = home, 3x = services)
          if (e.key === 'ArrowUp') {
            upTapCount++;

            if (upTapTimer) {
              clearTimeout(upTapTimer);
            }

            // Triple tap = services
            if (upTapCount === 3) {
              e.preventDefault();
              window.location.href = '/services';
              upTapCount = 0;
              return;
            }

            // Double tap = home
            if (upTapCount === 2) {
              e.preventDefault();
              // Wait a bit to see if there's a 3rd tap
              upTapTimer = setTimeout(() => {
                if (upTapCount === 2) {
                  window.location.href = '/home';
                }
                upTapCount = 0;
              }, TAP_THRESHOLD);
              return;
            }

            // First tap, wait for more
            upTapTimer = setTimeout(() => {
              upTapCount = 0;
            }, TAP_THRESHOLD);
          }

          // Enter taps (2x = theme)
          if (e.key === 'Enter') {
            enterTapCount++;

            if (enterTapTimer) {
              clearTimeout(enterTapTimer);
            }

            // Double tap = theme
            if (enterTapCount === 2) {
              e.preventDefault();
              if (window.ThemeManager && typeof window.ThemeManager.cycleTheme === 'function') {
                window.ThemeManager.cycleTheme();
              }
              enterTapCount = 0;
              return;
            }

            // First tap, wait for more
            enterTapTimer = setTimeout(() => {
              enterTapCount = 0;
            }, TAP_THRESHOLD);
          }
        });
      })();
    </script>
  </body>
</html>
